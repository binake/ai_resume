<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI简历分析系统</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="container">
        <!-- 左侧工作台 -->
        <div class="workspace">
            <div class="workspace-header">
                <div class="workspace-title">工作台</div>
                <div class="workspace-subtitle">AI简历分析系统</div>
            </div>

            <div class="workspace-content">
                <!-- 我的项目 -->
                <div class="workspace-section">
                    <div class="section-header" data-section="projects">
                        <span>我的项目</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content" id="projectsSection">
                        <div class="add-project" onclick="showNewProjectInput()">
                            <span>+ 新建项目</span>
                        </div>
                        <div class="new-project-input" id="newProjectInput">
                            <input type="text" placeholder="输入项目名称" onkeypress="handleNewProject(event)">
                        </div>
                    </div>
                </div>

                <!-- API接口测试 -->
                <div class="workspace-section">
                    <div class="section-header" data-section="api">
                        <span>测试新的API接口</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content" id="apiSection">
                        <div class="nav-item" data-page="api-test">
                            <span class="nav-icon">🔧</span>
                            <span>API测试</span>
                        </div>
                        <div class="nav-item" data-page="api-config">
                            <span class="nav-icon">⚙️</span>
                            <span>接口配置</span>
                        </div>
                        <div class="nav-item" data-page="rag-config">
                            <span class="nav-icon">📚</span>
                            <span>RAG配置</span>
                        </div>
                    </div>
                </div>

                <!-- AI对话 -->
                <div class="workspace-section">
                    <div class="section-header" data-section="ai">
                        <span>AI对话</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content" id="aiSection">
                        <div class="nav-item" data-page="ai-chat">
                            <span class="nav-icon">💬</span>
                            <span>智能对话</span>
                        </div>
                        <div class="nav-item" data-page="ai-analysis">
                            <span class="nav-icon">🤖</span>
                            <span>智能分析</span>
                        </div>
                    </div>
                </div>

                <!-- 数据管理 -->
                <div class="workspace-section">
                    <div class="section-header active" data-section="data">
                        <span>数据（知识库）检索</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content" id="dataSection">
                        <div class="nav-item active" data-page="dashboard">
                            <span class="nav-icon">📊</span>
                            <span>仪表板</span>
                        </div>
                        <div class="nav-item" data-page="resumes">
                            <span class="nav-icon">📋</span>
                            <span>简历管理</span>
                        </div>
                        <div class="nav-item" data-page="analytics">
                            <span class="nav-icon">📈</span>
                            <span>数据分析</span>
                        </div>
                        <div class="nav-item" data-page="knowledge">
                            <span class="nav-icon">📚</span>
                            <span>知识库</span>
                        </div>
                    </div>
                </div>

                <!-- 数据上传 -->
                <div class="workspace-section">
                    <div class="section-header" data-section="upload">
                        <span>数据上传</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content" id="uploadSection">
                        <div class="nav-item" data-page="upload-resume">
                            <span class="nav-icon">📄</span>
                            <span>个人简历上传</span>
                        </div>
                        <div class="nav-item" data-page="upload-company">
                            <span class="nav-icon">🏢</span>
                            <span>公司介绍上传</span>
                        </div>
                        <div class="nav-item" data-page="upload-job">
                            <span class="nav-icon">💼</span>
                            <span>工作条件上传</span>
                        </div>
                        <div class="nav-item" data-page="upload-knowledge">
                            <span class="nav-icon">📝</span>
                            <span>知识纪要上传</span>
                        </div>
                    </div>
                </div>

                <!-- 系统设置 -->
                <div class="workspace-section">
                    <div class="section-header" data-section="settings">
                        <span>系统设置</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content" id="settingsSection">
                        <div class="nav-item" data-page="settings">
                            <span class="nav-icon">⚙️</span>
                            <span>系统配置</span>
                        </div>
                        <div class="nav-item" data-page="user-settings">
                            <span class="nav-icon">👤</span>
                            <span>用户设置</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 顶部导航栏 -->
            <div class="top-bar">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">首页</span>
                    <span>›</span>
                    <span class="breadcrumb-item active" id="currentPage">仪表板</span>
                </div>
                <div class="user-actions">
                    <button class="action-btn secondary" onclick="testConnection()">测试连接</button>
                    <button class="action-btn" onclick="refreshData()">刷新数据</button>
                </div>
            </div>

            <!-- 页面内容 -->
            <div class="page-content">
                <!-- 仪表板页面 -->
                <div class="content-area active" id="dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📋</div>
                            <div class="stat-number" id="totalResumes">0</div>
                            <div class="stat-label">总简历数</div>
                            <div class="stat-trend">+5% 本周</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🆕</div>
                            <div class="stat-number" id="newResumes">0</div>
                            <div class="stat-label">今日新增</div>
                            <div class="stat-trend">+12% 较昨日</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-number" id="avgSkills">0</div>
                            <div class="stat-label">平均技能数</div>
                            <div class="stat-trend">+8% 本月</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⭐</div>
                            <div class="stat-number">96%</div>
                            <div class="stat-label">解析成功率</div>
                            <div class="stat-trend">+2% 本月</div>
                        </div>
                    </div>

                    <div class="controls-panel">
                        <div class="controls-row">
                            <div class="search-box">
                                <input type="text" class="search-input" id="searchInput" placeholder="搜索简历...">
                                <span class="search-icon">🔍</span>
                            </div>
                            <div class="filter-group">
                                <select class="filter-select" id="skillFilter">
                                    <option value="">所有技能</option>
                                </select>
                                <select class="filter-select" id="eduFilter">
                                    <option value="">所有学历</option>
                                </select>
                                <button class="action-btn" onclick="exportData()">导出数据</button>
                            </div>
                        </div>
                    </div>

                    <div class="resume-grid" id="resumeGrid">
                        <div class="loading">
                            <div class="spinner"></div>
                            正在加载简历数据...
                        </div>
                    </div>
                </div>

                <!-- 简历管理页面 -->
                <div class="content-area" id="resumes">
                    <h2 style="margin-bottom: 20px;">简历管理</h2>
                    <div class="resume-grid" id="resumeManagementGrid">
                        <!-- 简历管理内容 -->
                    </div>
                </div>

                <!-- 项目文件上传页面 -->
                <div class="content-area" id="project-upload">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 id="projectUploadTitle">项目文件上传</h2>
                            <span class="page-type-indicator project">项目存储</span>
                        </div>
                        <button class="action-btn secondary" onclick="loadProjectFiles()">查看已上传文件</button>
                    </div>
                    <div class="upload-area" id="uploadArea-project">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">拖放文件到此处，或点击上传</div>
                        <div class="upload-hint">支持 PDF、DOC、DOCX、TXT、图片等格式 | 支持多文件选择和文件夹上传</div>
                        <input type="file" id="fileInput-project" style="display: none;" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif,.xls,.xlsx,.ppt,.pptx,.md" multiple>
                        <div style="margin-top: 15px;">
                            <button class="action-btn secondary" onclick="selectFiles('project')">选择文件</button>
                            <button class="action-btn secondary" onclick="selectFolder('project')" style="margin-left: 10px;">选择文件夹</button>
                        </div>
                    </div>
                    <div id="uploadProgress-project" style="display: none;">
                        <div class="loading">
                            <div class="spinner"></div>
                            正在上传文件...
                        </div>
                    </div>
                </div>

                <!-- 上传简历页面 -->
                <div class="content-area" id="upload-resume">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2>个人简历上传</h2>
                            <span class="page-type-indicator category">分类存储</span>
                        </div>
                        <button class="action-btn secondary" onclick="loadCategoryFiles('resume')">查看已上传文件</button>
                    </div>
                    <div class="upload-area" id="uploadArea-resume">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text">拖放简历文件到此处，或点击上传</div>
                        <div class="upload-hint">支持 PDF、DOC、DOCX 格式 | 支持多文件选择和文件夹上传</div>
                        <input type="file" id="fileInput-resume" style="display: none;" accept=".pdf,.doc,.docx" multiple>
                        <div style="margin-top: 15px;">
                            <button class="action-btn secondary" onclick="selectFiles('resume')">选择文件</button>
                            <button class="action-btn secondary" onclick="selectFolder('resume')" style="margin-left: 10px;">选择文件夹</button>
                        </div>
                    </div>
                    <div id="uploadProgress-resume" style="display: none;">
                        <div class="loading">
                            <div class="spinner"></div>
                            正在上传并解析简历...
                        </div>
                    </div>
                </div>

                <!-- 公司介绍上传页面 -->
                <div class="content-area" id="upload-company">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2>公司介绍上传</h2>
                            <span class="page-type-indicator category">分类存储</span>
                        </div>
                        <button class="action-btn secondary" onclick="loadCategoryFiles('company')">查看已上传文件</button>
                    </div>
                    <div class="upload-area" id="uploadArea-company">
                        <div class="upload-icon">🏢</div>
                        <div class="upload-text">上传公司介绍文件</div>
                        <div class="upload-hint">支持 PDF、DOC、DOCX、TXT 格式 | 支持多文件选择和文件夹上传</div>
                        <input type="file" id="fileInput-company" style="display: none;" accept=".pdf,.doc,.docx,.txt" multiple>
                        <div style="margin-top: 15px;">
                            <button class="action-btn secondary" onclick="selectFiles('company')">选择文件</button>
                            <button class="action-btn secondary" onclick="selectFolder('company')" style="margin-left: 10px;">选择文件夹</button>
                        </div>
                    </div>
                    <div id="uploadProgress-company" style="display: none;">
                        <div class="loading">
                            <div class="spinner"></div>
                            正在上传文件...
                        </div>
                    </div>
                </div>

                <!-- 工作条件上传页面 -->
                <div class="content-area" id="upload-job">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2>工作条件上传</h2>
                            <span class="page-type-indicator category">分类存储</span>
                        </div>
                        <button class="action-btn secondary" onclick="loadCategoryFiles('job')">查看已上传文件</button>
                    </div>
                    <div class="upload-area" id="uploadArea-job">
                        <div class="upload-icon">💼</div>
                        <div class="upload-text">上传工作条件说明</div>
                        <div class="upload-hint">支持 PDF、DOC、DOCX、TXT 格式 | 支持多文件选择和文件夹上传</div>
                        <input type="file" id="fileInput-job" style="display: none;" accept=".pdf,.doc,.docx,.txt" multiple>
                        <div style="margin-top: 15px;">
                            <button class="action-btn secondary" onclick="selectFiles('job')">选择文件</button>
                            <button class="action-btn secondary" onclick="selectFolder('job')" style="margin-left: 10px;">选择文件夹</button>
                        </div>
                    </div>
                    <div id="uploadProgress-job" style="display: none;">
                        <div class="loading">
                            <div class="spinner"></div>
                            正在上传文件...
                        </div>
                    </div>
                </div>

                <!-- 知识纪要上传页面 -->
                <div class="content-area" id="upload-knowledge">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2>知识纪要上传</h2>
                            <span class="page-type-indicator category">分类存储</span>
                        </div>
                        <button class="action-btn secondary" onclick="loadCategoryFiles('knowledge')">查看已上传文件</button>
                    </div>
                    <div class="upload-area" id="uploadArea-knowledge">
                        <div class="upload-icon">📝</div>
                        <div class="upload-text">上传知识库文档</div>
                        <div class="upload-hint">支持 PDF、DOC、DOCX、TXT、MD 格式 | 支持多文件选择和文件夹上传</div>
                        <input type="file" id="fileInput-knowledge" style="display: none;" accept=".pdf,.doc,.docx,.txt,.md" multiple>
                        <div style="margin-top: 15px;">
                            <button class="action-btn secondary" onclick="selectFiles('knowledge')">选择文件</button>
                            <button class="action-btn secondary" onclick="selectFolder('knowledge')" style="margin-left: 10px;">选择文件夹</button>
                        </div>
                    </div>
                    <div id="uploadProgress-knowledge" style="display: none;">
                        <div class="loading">
                            <div class="spinner"></div>
                            正在上传文件...
                        </div>
                    </div>
                </div>

                <!-- API测试页面 -->
                <div class="content-area" id="api-test">
                    <h2 style="margin-bottom: 20px;">API接口测试</h2>
                    <div class="stat-card">
                        <h3 style="margin-bottom: 15px;">接口测试工具</h3>
                        <div class="info-row">
                            <span class="info-label">当前API:</span>
                            <span class="info-value" id="currentApiUrl">http://localhost:5000/api</span>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="action-btn" onclick="testAllEndpoints()">测试所有接口</button>
                            <button class="action-btn secondary" onclick="getSystemInfo()" style="margin-left: 10px;">获取系统信息</button>
                        </div>
                    </div>
                </div>

                <!-- RAG配置页面 -->
                <div class="content-area" id="rag-config">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 style="margin-bottom: 8px; color: #1a73e8;">📚 RAG配置</h2>
                            <p style="color: #5f6368; font-size: 14px;">配置RAGFlow知识库同步功能</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="action-btn secondary" onclick="testRagConnection()">
                                🔗 测试连接
                            </button>
                            <button class="action-btn secondary" onclick="testRagDocumentUpload()" style="margin-left: 10px;">测试文档上传</button>
                            <button class="action-btn secondary" onclick="saveRagConfig()" style="margin-left: 10px;">保存配置</button>
                        </div>
                    </div>
                    
                    <!-- 知识库选择区域 -->
                    <div class="config-section">
                        <h3>📚 知识库配置</h3>
                        <div class="config-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div>
                                    <h4 style="margin-bottom: 8px; color: #202124;">选择知识库</h4>
                                    <p style="color: #5f6368; font-size: 14px; line-height: 1.5;">
                                        选择要同步文档的目标知识库。点击知识库名称进行选择，选中的知识库会高亮显示。
                                    </p>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="action-btn" onclick="loadDatasets()">
                                        🔄 刷新列表
                                    </button>
                                    <button class="action-btn secondary" onclick="testRender()" style="font-size: 12px;">
                                        🧪 测试渲染
                                    </button>
                                </div>
                            </div>
                            
                            <div id="datasetsList" class="datasets-container" style="max-height: 400px; overflow-y: auto; border: 2px solid #e8eaed; border-radius: 12px; background: #fafafa; margin-top: 16px; padding: 8px;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    正在加载知识库列表...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 同步配置区域 -->
                    <div class="config-section">
                        <h3>⚙️ 同步配置</h3>
                        <div class="config-card">
                            <div class="config-row">
                                <label class="config-label">RAG API地址:</label>
                                <input type="text" id="ragApiUrl" value="http://localhost/api/v1" class="config-input" placeholder="输入RAG API地址">
                            </div>
                            <div class="config-row">
                                <label class="config-label">API密钥:</label>
                                <input type="password" id="ragApiKey" class="config-input" placeholder="输入API密钥">
                            </div>
                            <div class="config-row">
                                <label class="config-label">当前选择的知识库:</label>
                                <span id="selectedDataset" class="config-value">未选择</span>
                            </div>
                            
                            <!-- 同步方式配置 -->
                            <div class="config-row">
                                <label class="config-label">同步方式:</label>
                                <select id="syncMethod" class="config-input">
                                    <option value="server">直接从服务器加载（推荐）</option>
                                    <option value="url">直接使用文件链接</option>
                                    <option value="download">下载后上传（兼容性更好）</option>
                                    <option value="smart">智能同步（先尝试链接，失败则下载）</option>
                                    <option value="auto">自动选择（先尝试链接，失败则下载）</option>
                                </select>
                            </div>
                            
                            <!-- 快速配置区域 -->
                            <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e8eaed;">
                                <h5 style="margin-bottom: 12px; color: #5f6368; font-size: 14px;">🚀 快速配置</h5>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button class="btn-small secondary" onclick="quickConfig('local')" style="font-size: 12px;">
                                        本地RAGFlow
                                    </button>
                                    <button class="btn-small secondary" onclick="quickConfig('test')" style="font-size: 12px;">
                                        测试环境
                                    </button>
                                    <button class="btn-small secondary" onclick="quickConfig('prod')" style="font-size: 12px;">
                                        生产环境
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8eaed;">
                                <div style="display: flex; gap: 12px;">
                                    <button class="action-btn" onclick="saveRagConfig()">
                                        💾 保存配置
                                    </button>
                                    <button class="action-btn secondary" onclick="testRagConnection()">
                                        🔗 测试连接
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 同步状态区域 -->
                    <div class="config-section">
                        <h3>📊 同步状态</h3>
                        <div class="config-card">
                            <div class="sync-stats">
                                <div class="sync-stat-item">
                                    <div class="sync-stat-number" id="totalFiles">0</div>
                                    <div class="sync-stat-label">总文件数</div>
                                </div>
                                <div class="sync-stat-item">
                                    <div class="sync-stat-number" id="syncedFiles">0</div>
                                    <div class="sync-stat-label">已同步</div>
                                </div>
                                <div class="sync-stat-item">
                                    <div class="sync-stat-number" id="failedFiles">0</div>
                                    <div class="sync-stat-label">同步失败</div>
                                </div>
                                <div class="sync-stat-item">
                                    <div class="sync-stat-number" id="pendingFiles">0</div>
                                    <div class="sync-stat-label">待同步</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e8eaed;">
                                <div style="display: flex; gap: 12px;">
                                    <button class="action-btn" onclick="syncAllFiles()">
                                        🔄 同步所有文件
                                    </button>
                                    <button class="action-btn secondary" onclick="clearSyncStatus()">
                                        🗑️ 清除状态
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI对话页面（只在这里有iframe） -->
                <div class="content-area" id="ai-chat" style="height: calc(100vh - 60px); min-height: 600px;">
                    <div style="flex: 1; display: flex; flex-direction: column; height: 100%;">
                        <iframe
                            src="http://localhost/chat"
                            style="width: 100%; height: 100%; border: none;"
                            frameborder="0"
                        ></iframe>
                    </div>
                </div>
                <!-- AI对话页面（只在这里有iframe） -->
                <div class="content-area" id="ai-analysis" style="height: calc(100vh - 60px); min-height: 600px;">
                    <div style="flex: 1; display: flex; flex-direction: column; height: 100%;">
                        <iframe
                            src="http://localhost/search"
                            style="width: 100%; height: 100%; border: none;"
                            frameborder="0"
                        ></iframe>
                    </div>
                </div>

                <!-- 数据分析页面 -->
                <div class="content-area" id="analytics">
                    <h2 style="margin-bottom: 20px;">数据分析</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">🏫</div>
                            <div class="stat-number">985</div>
                            <div class="stat-label">985院校比例</div>
                            <div class="stat-trend">35%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💼</div>
                            <div class="stat-number">3.2年</div>
                            <div class="stat-label">平均工作经验</div>
                            <div class="stat-trend">经验分布均匀</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔧</div>
                            <div class="stat-number">Java</div>
                            <div class="stat-label">热门技能</div>
                            <div class="stat-trend">45% 掌握率</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🌍</div>
                            <div class="stat-number">北京</div>
                            <div class="stat-label">主要城市</div>
                            <div class="stat-trend">28% 分布</div>
                        </div>
                    </div>
                </div>

                <!-- 知识库页面 -->
                <div class="content-area" id="knowledge">
                    <h2 style="margin-bottom: 20px;">知识库管理</h2>
                    <div class="stat-card">
                        <h3 style="margin-bottom: 15px;">知识库统计</h3>
                        <div class="info-row">
                            <span class="info-label">文档总数:</span>
                            <span class="info-value">156</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">今日新增:</span>
                            <span class="info-value">8</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">检索次数:</span>
                            <span class="info-value">1,245</span>
                        </div>
                    </div>
                </div>

                <!-- 系统设置页面 -->
                <div class="content-area" id="settings">
                    <h2 style="margin-bottom: 20px;">系统设置</h2>
                    <div class="stat-card">
                        <h3 style="margin-bottom: 15px;">API配置</h3>
                        <div class="info-row">
                            <span class="info-label">API地址:</span>
                            <span class="info-value" id="apiUrl">http://localhost:5000/api</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">数据库:</span>
                            <span class="info-value">MongoDB (ai_resume)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">文件存储:</span>
                            <span class="info-value">本地文件系统</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">状态:</span>
                            <span class="info-value" id="connectionStatus">检查中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 项目管理模态框 -->
    <div class="modal" id="projectManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>项目管理</h3>
                <button class="close-btn" onclick="closeProjectManager()">×</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">创建新项目</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newProjectNameInput" placeholder="项目名称" style="flex: 1; padding: 8px 12px; border: 1px solid #dadce0; border-radius: 6px;">
                        <input type="text" id="newProjectDescInput" placeholder="项目描述（可选）" style="flex: 2; padding: 8px 12px; border: 1px solid #dadce0; border-radius: 6px;">
                        <button class="action-btn" onclick="createProjectFromModal()">创建</button>
                    </div>
                </div>

                <div>
                    <h4 style="margin-bottom: 10px;">现有项目</h4>
                    <div id="projectManagerList">
                        <!-- 项目列表将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">详情</h3>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 详情内容 -->
            </div>
        </div>
    </div>
    
    <div class="sidemodal" id="detailSideModal">
        <div class="sideModal-body" id ="sideModalBody">
            
        </div>
    </div>

    <!-- 状态消息 -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // 全局变量
        const API_BASE_URL = 'http://localhost:5000/api';
        let allResumes = [];
        let filteredResumes = [];
        let currentPage = 'dashboard';
        let currentProject = null;
        let allProjects = [];
        let currentCategoryFiles = {}; // 存储各类别的文件列表
        let currentProjectFiles = []; // 存储当前项目的文件列表
        let currentDashboardFileId = null;

        // 字段分组定义 - 使用后端返回的自定义结构
        let FIELD_GROUPS = {};
        let FIELD_STRUCTURE = {};
        let FIELD_GROUPS_DISPLAY = {};

        // 分组名称映射（用于显示中文名称）
        let GROUP_NAME_MAP = {};

        // 初始化字段结构
        async function initializeFieldStructure() {
            try {
                // 获取字段结构定义
                const structureResponse = await fetch(`${API_BASE_URL}/fields/structure`);
                if (structureResponse.ok) {
                    FIELD_STRUCTURE = await structureResponse.json();
                    
                    // 构建字段分组
                    for (const [groupKey, fields] of Object.entries(FIELD_STRUCTURE)) {
                        FIELD_GROUPS[groupKey] = Object.keys(fields);
                    }
                }

                // 获取字段分组显示配置
                const groupsResponse = await fetch(`${API_BASE_URL}/fields/groups`);
                if (groupsResponse.ok) {
                    FIELD_GROUPS_DISPLAY = await groupsResponse.json();
                    
                    // 构建分组名称映射
                    for (const [groupKey, config] of Object.entries(FIELD_GROUPS_DISPLAY)) {
                        GROUP_NAME_MAP[groupKey] = config.name;
                    }
                }

                console.log('字段结构初始化完成:', {
                    FIELD_STRUCTURE,
                    FIELD_GROUPS,
                    FIELD_GROUPS_DISPLAY,
                    GROUP_NAME_MAP
                });
            } catch (error) {
                console.error('字段结构初始化失败:', error);
                // 使用默认结构作为后备
                initializeDefaultFieldStructure();
            }
        }

        // 默认字段结构（作为后备）- 基于ResumeSDK官方文档
        function initializeDefaultFieldStructure() {
            FIELD_GROUPS = {
                'basic_info': ['name', 'gender', 'age', 'birthday', 'mobile', 'email', 'living_address', 'hometown_address', 'hukou_address', 'city', 'race', 'surname', 'workExpYear', 'github', 'zhihu', 'wechat', 'qq', 'linkedin', 'blog', 'website', 'avatar', 'expect_job', 'expect_salary', 'expect_city', 'expect_industry', 'resume_name', 'resume_update_time', 'resume_text'],
                'education': ['college', 'major', 'education', 'degree', 'college_type', 'college_rank', 'grad_time', 'education_start_time', 'education_end_time', 'gpa', 'course', 'education_desc'],
                'work_experience': ['company_name', 'department_name', 'job_position', 'work_time', 'work_start_time', 'work_end_time', 'work_desc', 'salary', 'work_type', 'industry', 'company_size', 'company_nature', 'report_to', 'subordinates', 'achievement'],
                'project_experience': ['project_name', 'project_role', 'project_time', 'project_start_time', 'project_end_time', 'project_desc', 'project_content', 'project_technology', 'project_result', 'project_scale', 'project_budget', 'project_team_size'],
                'skills': ['skill_name', 'skill_level', 'skill_desc', 'skill_years', 'skill_category'],
                'language_skills': ['language_name', 'language_level', 'language_certificate', 'language_score'],
                'certificates': ['award_info', 'award_time', 'award_desc', 'award_level', 'award_issuer', 'certificate_type'],
                'training': ['training_name', 'training_time', 'training_desc', 'training_institution', 'training_certificate', 'training_duration'],
                'social_practice': ['practice_name', 'practice_time', 'practice_desc', 'practice_role', 'practice_organization'],
                'self_evaluation': ['aboutme_desc', 'self_introduction', 'hobby', 'strength', 'weakness', 'career_goal']
            };

            GROUP_NAME_MAP = {
                'basic_info': '基本信息',
                'education': '教育经历',
                'work_experience': '工作经历',
                'project_experience': '项目经历',
                'skills': '技能列表',
                'language_skills': '语言技能',
                'certificates': '证书奖项',
                'training': '培训经历',
                'social_practice': '社会实践',
                'self_evaluation': '个人评价'
            };
        }

        // 文件类别映射
        const FILE_CATEGORIES = {
            'resume': '个人简历',
            'company': '公司介绍',
            'job': '工作条件',
            'knowledge': '知识纪要'
        };

        // 创建日志对象
        const logger = {
            info: (message) => {
                console.log(`[INFO] ${message}`);
            },
            error: (message) => {
                console.error(`[ERROR] ${message}`);
            },
            warn: (message) => {
                console.warn(`[WARN] ${message}`);
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // 首先初始化字段结构
            await initializeFieldStructure();
            
            setupEventListeners();
            await loadProjects();
            await loadData();
            updateStats();
            
            // 初始化RAG配置
            if (document.getElementById('rag-config')) {
                loadRagConfig();
                updateSyncStats();
            }
        }

        function setupEventListeners() {
            // 侧边栏导航点击
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    if (page) {
                        switchPage(page);
                    }
                });
            });

            // 分区折叠/展开
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', function() {
                    toggleSection(this.dataset.section);
                });
            });

            // 搜索
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // 为每个类别设置上传事件
            Object.keys(FILE_CATEGORIES).forEach(category => {
                setupCategoryUpload(category);
            });

            // 为项目上传设置事件
            setupProjectUpload();

            // 模态框点击外部关闭
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            document.getElementById('projectManagerModal').addEventListener('click', function(e) {
                if (e.target === this) closeProjectManager();
            });
        }

        function setupCategoryUpload(category) {
            const uploadArea = document.getElementById(`uploadArea-${category}`);
            const fileInput = document.getElementById(`fileInput-${category}`);

            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                fileInput.click();
            });

            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', (e) => handleDrop(e, category));

            fileInput.addEventListener('change', (e) => handleFileSelect(e, category));
        }

        function setupProjectUpload() {
            const uploadArea = document.getElementById('uploadArea-project');
            const fileInput = document.getElementById('fileInput-project');

            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                fileInput.click();
            });

            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', (e) => handleDrop(e, 'project'));

            fileInput.addEventListener('change', (e) => handleFileSelect(e, 'project'));
        }

        function selectFiles(category) {
            const fileInput = document.getElementById(`fileInput-${category}`);
            if (fileInput) {
                fileInput.removeAttribute('webkitdirectory');
                fileInput.click();
            }
        }

        function selectFolder(category) {
            const fileInput = document.getElementById(`fileInput-${category}`);
            if (fileInput) {
                fileInput.setAttribute('webkitdirectory', '');
                fileInput.click();
            }
        }

        function switchProject(projectId) {
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
            });

            const projectElement = document.querySelector(`[data-project="${projectId}"]`);
            if (projectElement) {
                projectElement.classList.add('active');
            }

            currentProject = projectId;
            const project = allProjects.find(p => p._id === projectId);
            const projectName = project ? project.name : '未知项目';

            // 切换到项目文件上传页面
            switchPage('project-upload');

            // 更新项目上传页面的标题
            const titleElement = document.getElementById('projectUploadTitle');
            if (titleElement) {
                titleElement.textContent = `${projectName} - 文件上传`;
            }

            showMessage(`已切换到项目: ${projectName}`, 'info');

            // 加载项目文件列表
            loadProjectFiles();
        }

        function toggleSection(sectionId) {
            const header = document.querySelector(`[data-section="${sectionId}"]`);
            const content = document.getElementById(sectionId + 'Section');

            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        function switchPage(page) {
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItem = document.querySelector(`[data-page="${page}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // 更新面包屑
            const pageNames = {
                'dashboard': '仪表板',
                'resumes': '简历管理',
                'project-upload': '项目文件上传',
                'upload-resume': '个人简历上传',
                'upload-company': '公司介绍上传',
                'upload-job': '工作条件上传',
                'upload-knowledge': '知识纪要上传',
                'api-test': 'API测试',
                'ai-chat': 'AI对话',
                'analytics': '数据分析',
                'knowledge': '知识库',
                'settings': '系统设置'
            };
            document.getElementById('currentPage').textContent = pageNames[page] || page;

            // 切换页面内容
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById(page).classList.add('active');

            currentPage = page;

            // 加载页面特定内容
            if (page === 'resumes') {
                loadResumeManagement();
            } else if (page === 'settings') {
                checkConnectionStatus();
            } else if (page.startsWith('upload-')) {
                const category = page.replace('upload-', '');
                if (FILE_CATEGORIES[category]) {
                    loadCategoryFiles(category);
                }
            } else if (page === 'project-upload') {
                loadProjectFiles();
            }
        }

        function showNewProjectInput() {
            const inputDiv = document.getElementById('newProjectInput');
            inputDiv.style.display = 'block';
            inputDiv.querySelector('input').focus();
        }

        function handleNewProject(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const projectName = input.value.trim();

                if (projectName) {
                    createProject(projectName).then(success => {
                        if (success) {
                            input.value = '';
                            document.getElementById('newProjectInput').style.display = 'none';
                        }
                    });
                }
            } else if (event.key === 'Escape') {
                event.target.value = '';
                document.getElementById('newProjectInput').style.display = 'none';
            }
        }

        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE_URL}/projects`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                allProjects = await response.json();
                renderProjectList();

                if (!currentProject && allProjects.length > 0) {
                    currentProject = allProjects[0]._id;
                }

                logger.info(`成功加载 ${allProjects.length} 个项目`);

            } catch (error) {
                console.error('加载项目失败:', error);
                showMessage('加载项目失败: ' + error.message, 'error');
            }
        }

        function renderProjectList() {
            const projectsSection = document.getElementById('projectsSection');
            if (!projectsSection) return;

            const addProjectElement = projectsSection.querySelector('.add-project');
            const newProjectInputElement = projectsSection.querySelector('.new-project-input');

            const projectItems = projectsSection.querySelectorAll('.project-item');
            projectItems.forEach(item => item.remove());

            allProjects.forEach((project, index) => {
                const projectElement = document.createElement('div');
                projectElement.className = `project-item ${index === 0 && !currentProject ? 'active' : ''}`;
                projectElement.setAttribute('data-project', project._id);
                projectElement.innerHTML = `
                    <div class="project-dot"></div>
                    <span id="sidebarProjectNameDisplay-${project._id}" title="${project.description || project.name}">${project.name}</span>
                    <input id="sidebarProjectNameInput-${project._id}" type="text" value="${project.name}" style="display:none; padding:2px 6px; font-size:14px; border:1px solid #dadce0; border-radius:4px; min-width:60px; margin-left:4px;" onkeydown="handleSidebarProjectNameEdit(event, '${project._id}')" />
                    <button class="btn-small" style="margin-left:4px;" onclick="showSidebarProjectNameEdit('${project._id}');event.stopPropagation();">编辑</button>
                `;
                projectElement.addEventListener('click', function() {
                    switchProject(project._id);
                });
                projectsSection.insertBefore(projectElement, addProjectElement);
            });

            if (!currentProject && allProjects.length > 0) {
                currentProject = allProjects[0]._id;
                document.querySelector(`[data-project="${currentProject}"]`)?.classList.add('active');
            }
        }

        async function createProject(name, description = '') {
            try {
                const response = await fetch(`${API_BASE_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, description })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`项目 "${name}" 创建成功`, 'success');
                    await loadProjects();

                    if (result.project) {
                        switchProject(result.project._id);
                    }

                    return true;
                } else {
                    showMessage(result.error || '创建项目失败', 'error');
                    return false;
                }

            } catch (error) {
                console.error('创建项目失败:', error);
                showMessage('创建项目失败: ' + error.message, 'error');
                return false;
            }
        }

        async function loadData() {
            try {
                showMessage('正在加载数据...', 'info');
                const response = await fetch(`${API_BASE_URL}/resume/all`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // 调试信息：检查API返回的原始数据
                console.log('API返回的原始数据:', data);
                if (data.length > 0) {
                    const firstResume = data[0];
                    console.log('第一条简历数据:', firstResume);
                    console.log('skills_objs 字段:', {
                        value: firstResume.skills_objs,
                        type: typeof firstResume.skills_objs,
                        isArray: Array.isArray(firstResume.skills_objs),
                        isObject: typeof firstResume.skills_objs === 'object' && firstResume.skills_objs !== null
                    });
                    console.log('job_exp_objs 字段:', {
                        value: firstResume.job_exp_objs,
                        type: typeof firstResume.job_exp_objs,
                        isArray: Array.isArray(firstResume.job_exp_objs),
                        isObject: typeof firstResume.job_exp_objs === 'object' && firstResume.job_exp_objs !== null
                    });
                }
                
                allResumes = data;
                filteredResumes = [...allResumes];

                renderResumeGrid();
                updateFilters();
                showMessage('数据加载成功', 'success');

            } catch (error) {
                console.error('加载数据失败:', error);
                showMessage('数据加载失败: ' + error.message, 'error');
                const gridElement = document.getElementById('resumeGrid');
                if (gridElement) {
                    gridElement.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                            <h3>数据加载失败</h3>
                            <p>请检查API连接状态</p>
                            <button class="action-btn" onclick="loadData()" style="margin-top: 20px;">重试</button>
                        </div>
                    `;
                }
            }
        }

        function updateStats() {
            const totalCount = allResumes.length;
            const todayCount = Math.floor(Math.random() * 5);
            const avgSkills = totalCount > 0 ? Math.round(
                allResumes.reduce((sum, resume) =>
                    sum + (resume.skills_objs ? resume.skills_objs.length : 0), 0) / totalCount
            ) : 0;

            const totalElement = document.getElementById('totalResumes');
            const newElement = document.getElementById('newResumes');
            const avgElement = document.getElementById('avgSkills');

            if (totalElement) totalElement.textContent = totalCount;
            if (newElement) newElement.textContent = todayCount;
            if (avgElement) avgElement.textContent = avgSkills;
        }

        function renderResumeGrid() {
            const grid = document.getElementById('resumeGrid');
            if (!grid) return;

            if (filteredResumes.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📋</div>
                        <h3>暂无简历数据</h3>
                        <p>请上传简历或检查搜索条件</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredResumes.map(resume => {
                // 健壮性处理：skills_objs 必须为数组
                const skills = Array.isArray(resume.skills_objs) ? resume.skills_objs : [];
                return `
                <div class="resume-card">
                    <input type="file" id="${resume._id}" style="display: none;" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif,.xls,.xlsx,.ppt,.pptx,.md">
                    <div class="card-header">
                        <div class="avatar">
                            ${resume.name ? resume.name.charAt(0) : 'U'}
                        </div>
                        <div class="card-info">
                            <h3>${resume.name || '未知姓名'}</h3>
                            <p>${resume.major || '专业待更新'}</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="info-row">
                            <span class="info-label">邮箱:</span>
                            <span class="info-value">${resume.email || '未提供'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">电话:</span>
                            <span class="info-value">${resume.phone || '未提供'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">学校:</span>
                            <span class="info-value">${resume.college || '未提供'}</span>
                        </div>
                            ${skills.length > 0 ? `
                            <div class="skills-tags">
                                    ${skills.slice(0, 3).map(skill =>
                                    `<span class="skill-tag">${skill.skills_name}</span>`
                                ).join('')}
                                    ${skills.length > 3 ?
                                        `<span class="skill-tag">+${skills.length - 3}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn-small primary" onclick="viewDetails('${resume._id}', '${resume.file_id}')">查看详情</button>
                        <button class="btn-small" onclick="editResume('${resume._id}')">编辑</button>
                        <button class="btn-small danger" onclick="deleteResume('${resume._id}')">删除</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateFilters() {
            const skillFilter = document.getElementById('skillFilter');
            const eduFilter = document.getElementById('eduFilter');

            if (!skillFilter || !eduFilter) return;

            const allSkills = new Set();
            allResumes.forEach(resume => {
                const skills = Array.isArray(resume.skills_objs) ? resume.skills_objs : [];
                skills.forEach(skill => {
                        allSkills.add(skill.skills_name);
                    });
            });

            skillFilter.innerHTML = '<option value="">所有技能</option>' +
                Array.from(allSkills).map(skill =>
                    `<option value="${skill}">${skill}</option>`
                ).join('');

            const allEducation = new Set();
            allResumes.forEach(resume => {
                if (resume.college) {
                    allEducation.add(resume.college);
                }
            });

            eduFilter.innerHTML = '<option value="">所有学校</option>' +
                Array.from(allEducation).slice(0, 20).map(edu =>
                    `<option value="${edu}">${edu}</option>`
                ).join('');
        }

        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase();

            if (!searchTerm) {
                filteredResumes = [...allResumes];
            } else {
                filteredResumes = allResumes.filter(resume => {
                    return (
                        (resume.name && resume.name.toLowerCase().includes(searchTerm)) ||
                        (resume.college && resume.college.toLowerCase().includes(searchTerm)) ||
                        (resume.email && resume.email.toLowerCase().includes(searchTerm)) ||
                        (resume.skills_objs && resume.skills_objs.some(skill =>
                            skill.skills_name && skill.skills_name.toLowerCase().includes(searchTerm)
                        ))
                    );
                });
            }

            renderResumeGrid();
        }

        // ============ 项目文件管理 ============
        async function loadProjectFiles() {
            if (!currentProject) {
                showMessage('请先选择一个项目', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/projects/${currentProject}/files`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const files = await response.json();
                currentProjectFiles = files;

                // 调试信息：显示从API返回的文件信息
                console.log('从API获取的项目文件信息:');
                files.forEach((file, index) => {
                    console.log(`文件 ${index + 1}:`, {
                        original_filename: file.original_filename,
                        filename: file.filename,
                        file_id: file.file_id,
                        size: file.size,
                        mimetype: file.mimetype
                    });
                });

                renderProjectFiles();

                logger.info(`成功加载项目文件: ${files.length} 个`);

            } catch (error) {
                console.error('加载项目文件失败:', error);
                showMessage('加载项目文件失败: ' + error.message, 'error');
                currentProjectFiles = [];
                renderProjectFiles();
            }
        }

        function renderProjectFiles() {
    const pageElement = document.getElementById('project-upload');
    if (!pageElement) return;

    let fileListContainer = pageElement.querySelector('.file-list-container');
    if (!fileListContainer) {
        fileListContainer = document.createElement('div');
        fileListContainer.className = 'file-list-container';
        pageElement.appendChild(fileListContainer);
    }

    const files = currentProjectFiles || [];
    const project = allProjects.find(p => p._id === currentProject);
    const projectName = project ? project.name : '当前项目';

    if (files.length === 0) {
        fileListContainer.innerHTML = `
            <h3 style="margin-bottom: 10px;">${projectName}的文件</h3>
            <p style="color: #666;">暂无文件</p>
        `;
        return;
    }

    fileListContainer.innerHTML = `
        <h3 style="margin-bottom: 10px;">${projectName}的文件 (${files.length}个)</h3>
        <div class="file-list">
            ${files.map((file, index) => {
                let displayName = '未知文件';
                if (file.original_filename && file.original_filename.trim() !== '') {
                    displayName = file.original_filename;
                } else if (file.filename && file.filename.trim() !== '') {
                    displayName = file.filename;
                }

                // 解析状态显示
                const parseStatus = file.parse_status || 'pending';
                const parseEnabled = file.parse_enabled !== false;

                let statusBadge = '';
                let statusColor = '';

                switch(parseStatus) {
                    case 'pending':
                        statusBadge = '未解析';
                        statusColor = '#666';
                        break;
                    case 'processing':
                        statusBadge = '解析中';
                        statusColor = '#1a73e8';
                        break;
                    case 'completed':
                        statusBadge = '已解析';
                        statusColor = '#34a853';
                        break;
                    case 'failed':
                        statusBadge = '解析失败';
                        statusColor = '#ea4335';
                        break;
                }

                return `
                <div class="file-card" data-file-id="${file.file_id}">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 24px;">${getFileIcon(file.mimetype)}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 4px; word-break: break-all;" title="${displayName}">
                                ${displayName}
                            </div>
                            <div style="font-size: 12px; color: #5f6368;">
                                ${formatFileSize(file.size)} • ${formatDate(file.upload_date)}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 12px; color: #5f6368;">启用解析:</span>
                                    <label class="switch" style="position: relative; display: inline-block; width: 34px; height: 20px;border-radius: 20px;background: grey;">
                                        <input type="checkbox" ${parseEnabled ? 'checked' : ''} onchange="toggleParseEnabled('${file.file_id}', this.checked)">
                                        <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 20px;"></span>
                                    </label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 12px; color: #5f6368;">解析状态:</span>
                                    <span style="font-size: 12px; color: ${statusColor}; font-weight: 500;">${statusBadge}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 12px; color: #5f6368;">RAG同步:</span>
                                    <span class="sync-status ${file.sync_status || 'pending'}">
                                        ${file.sync_status === 'completed' ? '已同步' : 
                                          file.sync_status === 'processing' ? '同步中...' : 
                                          file.sync_status === 'failed' ? '同步失败' : '待同步'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 解析、下载、删除、同步到RAG 以项目为单位区分显示-->
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-small primary" onclick="parseFile('${file.file_id}', '${displayName.replace(/'/g, "\\'")}')">
                            ${parseStatus === 'processing' ? '解析中...' : '解析'}
                        </button>
                        <button class="btn-small primary" onclick="downloadFile('${file.file_id}', '${displayName.replace(/'/g, "\\'")}')">
                            下载
                        </button>
                        <button class="btn-small danger" onclick="deleteProjectFile('${file.file_id}', '${displayName.replace(/'/g, "\\'")}')">
                            删除
                        </button>
                        <button class="btn-sync" onclick="syncFileToRagBackend('${file.file_id}')">
                            同步到RAG
                        </button>
                    </div>
                </div>
            `}).join('')}
        </div>
    `;
}

// 添加切换解析状态的函数
async function toggleParseEnabled(fileId, enabled) {
    try {
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/parse-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                parse_enabled: enabled
            })
        });

        const result = await response.json();

        if (response.ok) {
            showMessage(`解析状态已${enabled ? '启用' : '禁用'}`, 'success');
            await loadProjectFiles(); // 刷新文件列表
        } else {
            showMessage(result.error || '更新失败', 'error');
        }
    } catch (error) {
        console.error('更新解析状态失败:', error);
        showMessage('更新解析状态失败: ' + error.message, 'error');
    }
}

// 添加解析文件的函数
async function parseFile(fileId, filename) {
    try {
        showMessage(`开始解析文件: ${filename}`, 'info');
        // 调用后端解析API
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/parse`, {
            method: 'POST',
        });
        const result = await response.json();
        if (response.ok) {
                showMessage(`文件解析完成: ${filename}`, 'success');
        } else {
            showMessage(result.error || '解析失败', 'error');
        }
                await loadProjectFiles(); // 刷新显示
    } catch (error) {
        console.error('解析文件失败:', error);
        showMessage('解析文件失败: ' + error.message, 'error');
    }
}

        async function uploadProjectFiles(files) {
            if (!currentProject) {
                showMessage('请先选择一个项目', 'error');
                return false;
            }

            try {
                const formData = new FormData();

                // 添加调试信息：显示要上传的文件
                console.log('=== 准备上传项目文件 ===');
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                    console.log(`上传文件 ${i + 1}: "${files[i].name}" (${formatFileSize(files[i].size)})`);
                }

                showUploadProgress('project', true);

                const response = await fetch(`${API_BASE_URL}/projects/${currentProject}/files`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // 添加调试信息：显示服务器返回结果
                console.log('=== 服务器上传响应 ===');
                console.log('响应状态:', response.status);
                console.log('响应数据:', result);

                showUploadProgress('project', false);

                if (response.ok) {
                    const successCount = result.uploaded_files ? result.uploaded_files.length : 0;
                    let message = `成功上传 ${successCount} 个文件到项目`;

                    if (result.project_name) {
                        message += `: ${result.project_name}`;
                    }

                    // 显示每个上传文件的详细信息
                    if (result.uploaded_files) {
                        console.log('=== 上传成功的文件详情 ===');
                        result.uploaded_files.forEach((file, index) => {
                            console.log(`文件 ${index + 1}:`, {
                                original_filename: file.original_filename,
                                filename: file.filename,
                                file_id: file.file_id,
                                size: file.size
                            });
                        });
                    }

                    if (result.errors && result.errors.length > 0) {
                        message += `，${result.errors.length} 个文件失败`;
                        console.warn('上传错误:', result.errors);
                    }

                    showMessage(message, 'success');

                    // 重新加载项目文件列表
                    await loadProjectFiles();

                    return true;
                } else {
                    console.error('上传失败:', result);
                    showMessage(result.error || '文件上传失败', 'error');
                    return false;
                }

            } catch (error) {
                showUploadProgress('project', false);
                console.error('文件上传失败:', error);
                showMessage('文件上传失败: ' + error.message, 'error');
                return false;
            }
        }

        async function deleteProjectFile(fileId, filename) {
            try {
                if (!confirm(`确定要删除文件 "${filename}" 吗？`)) {
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/files/${fileId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`文件 "${filename}" 删除成功`, 'success');

                    // 重新加载项目文件列表
                    await loadProjectFiles();
                } else {
                    showMessage(result.error || '删除文件失败', 'error');
                }

            } catch (error) {
                console.error('删除文件失败:', error);
                showMessage('删除文件失败: ' + error.message, 'error');
            }
        }

        // ============ 分类文件管理 ============
        async function loadCategoryFiles(category) {
            try {
                const response = await fetch(`${API_BASE_URL}/files/category/${category}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const files = await response.json();
                currentCategoryFiles[category] = files;

                // 调试信息：显示从API返回的文件信息
                console.log(`从API获取的${FILE_CATEGORIES[category]}文件信息:`);
                files.forEach((file, index) => {
                    console.log(`文件 ${index + 1}:`, {
                        original_filename: file.original_filename,
                        filename: file.filename,
                        file_id: file.file_id,
                        size: file.size,
                        mimetype: file.mimetype
                    });
                });

                renderCategoryFiles(category);

                logger.info(`成功加载 ${category} 类别文件: ${files.length} 个`);

            } catch (error) {
                console.error(`加载 ${category} 文件失败:`, error);
                showMessage(`加载${FILE_CATEGORIES[category]}文件失败: ` + error.message, 'error');
                currentCategoryFiles[category] = [];
            }
        }

        function renderCategoryFiles(category) {
            const pageElement = document.getElementById(`upload-${category}`);
            if (!pageElement) return;

            let fileListContainer = pageElement.querySelector('.file-list-container');
            if (!fileListContainer) {
                fileListContainer = document.createElement('div');
                fileListContainer.className = 'file-list-container';
                pageElement.appendChild(fileListContainer);
            }

            const files = currentCategoryFiles[category] || [];
            const categoryName = FILE_CATEGORIES[category];

            if (files.length === 0) {
                fileListContainer.innerHTML = `
                    <h3 style="margin-bottom: 10px;">已上传的${categoryName}文件</h3>
                    <p style="color: #666;">暂无${categoryName}文件</p>
                `;
                return;
            }

            console.log(`=== 渲染${categoryName}文件列表 ===`);
            fileListContainer.innerHTML = `
                <h3 style="margin-bottom: 10px;">已上传的${categoryName}文件 (${files.length}个)</h3>
                <div class="file-list">
                    ${files.map((file, index) => {
                        // 更详细的文件名处理逻辑
                        let displayName = '未知文件';
                        if (file.original_filename && file.original_filename.trim() !== '') {
                            displayName = file.original_filename;
                        } else if (file.filename && file.filename.trim() !== '') {
                            displayName = file.filename;
                        }
                        // 解析状态显示
                        const parseStatus = file.parse_status || 'pending';
                        const parseEnabled = file.parse_enabled !== false;
                        let statusBadge = '';
                        let statusColor = '';
                        switch(parseStatus) {
                            case 'pending':
                                statusBadge = '未解析';
                                statusColor = '#666';
                                break;
                            case 'processing':
                                statusBadge = '解析中';
                                statusColor = '#1a73e8';
                                break;
                            case 'completed':
                                statusBadge = '已解析';
                                statusColor = '#34a853';
                                break;
                            case 'failed':
                                statusBadge = '解析失败';
                                statusColor = '#ea4335';
                                break;
                        }
                        return `
                        <div class="file-card" data-file-id="${file.file_id}">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 24px;">${getFileIcon(file.mimetype)}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; margin-bottom: 4px; word-break: break-all;" title="${displayName}">
                                        ${displayName}
                                    </div>
                                    <div style="font-size: 12px; color: #5f6368;">
                                        ${formatFileSize(file.size)} • ${formatDate(file.upload_date)}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 12px; color: #5f6368;">启用解析:</span>
                                            <label class="switch" style="position: relative; display: inline-block; width: 34px; height: 20px;border-radius: 20px;background: grey;">
                                                <input type="checkbox" ${parseEnabled ? 'checked' : ''} onchange="toggleParseEnabled('${file.file_id}', this.checked)">
                                                <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 20px;"></span>
                                            </label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span style="font-size: 12px; color: #5f6368;">解析状态:</span>
                                            <span style="font-size: 12px; color: ${statusColor}; font-weight: 500;">${statusBadge}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span style="font-size: 12px; color: #5f6368;">RAG同步:</span>
                                            <span class="sync-status ${file.sync_status || 'pending'}">
                                                ${file.sync_status === 'completed' ? '已同步' : 
                                                  file.sync_status === 'processing' ? '同步中...' : 
                                                  file.sync_status === 'failed' ? '同步失败' : '待同步'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 解析、下载、删除、同步到RAG 以数据上传区域单位区分显示-->
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-small primary" onclick="parseResumeFileAndRefresh('${file.file_id}', '${displayName.replace(/'/g, "\\'")}')" ${parseStatus === 'processing' ? 'disabled' : ''}>
                                    ${parseStatus === 'processing' ? '解析中...' : '解析'}
                                </button>
                                <button class="btn-small primary" onclick="downloadFile('${file.file_id}', '${displayName.replace(/'/g, "\\'")}')">
                                    下载
                                </button>
                                <button class="btn-small danger" onclick="deleteFile('${file.file_id}', '${displayName.replace(/'/g, "\\'")}', '${category}')">
                                    删除
                                </button>
                                <button class="btn-sync" onclick="syncFileToRagBackend('${file.file_id}')">
                                    同步到RAG
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        async function uploadCategoryFiles(files, category) {
            try {
                const formData = new FormData();
                console.log(`=== 准备上传${FILE_CATEGORIES[category]}文件 ===`);
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                    console.log(`上传文件 ${i + 1}: "${files[i].name}" (${formatFileSize(files[i].size)})`);
                }
                showUploadProgress(category, true);
                const response = await fetch(`${API_BASE_URL}/files/category/${category}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                console.log(`=== ${FILE_CATEGORIES[category]}上传响应 ===`);
                console.log('响应状态:', response.status);
                console.log('响应数据:', result);
                showUploadProgress(category, false);
                if (response.ok) {
                    const successCount = result.uploaded_files ? result.uploaded_files.length : 0;
                    let message = `成功上传 ${successCount} 个文件到${FILE_CATEGORIES[category]}`;
                    if (result.uploaded_files) {
                        console.log(`=== ${FILE_CATEGORIES[category]}上传成功的文件详情 ===`);
                        result.uploaded_files.forEach((file, index) => {
                            console.log(`文件 ${index + 1}:`, {
                                original_filename: file.original_filename,
                                filename: file.filename,
                                file_id: file.file_id,
                                size: file.size
                            });
                        });
                    }
                    if (result.errors && result.errors.length > 0) {
                        message += `，${result.errors.length} 个文件失败`;
                        console.warn('上传错误:', result.errors);
                    }
                    showMessage(message, 'success');
                    // 个人简历上传后自动解析
                    if (category === 'resume' && result.uploaded_files) {
                        for (const file of result.uploaded_files) {
                            await parseResumeFileAndRefresh(file.file_id, file.original_filename || file.filename);
                        }
                    }
                    // 重新加载文件列表
                    await loadCategoryFiles(category);
                    return true;
                } else {
                    console.error('上传失败:', result);
                    showMessage(result.error || '文件上传失败', 'error');
                    return false;
                }
            } catch (error) {
                showUploadProgress(category, false);
                console.error('文件上传失败:', error);
                showMessage('文件上传失败: ' + error.message, 'error');
                return false;
            }
        }

        function showUploadProgress(category, show) {
            const progressElement = document.getElementById(`uploadProgress-${category}`);
            if (progressElement) {
                progressElement.style.display = show ? 'block' : 'none';
            }
        }

        function getFileIcon(mimetype) {
            if (!mimetype) return '📄';

            if (mimetype.startsWith('image/')) return '🖼️';
            if (mimetype.startsWith('video/')) return '🎥';
            if (mimetype.startsWith('audio/')) return '🎵';
            if (mimetype.includes('pdf')) return '📑';
            if (mimetype.includes('word') || mimetype.includes('document')) return '📝';
            if (mimetype.includes('excel') || mimetype.includes('spreadsheet')) return '📊';
            if (mimetype.includes('powerpoint') || mimetype.includes('presentation')) return '📈';
            if (mimetype.includes('zip') || mimetype.includes('rar') || mimetype.includes('7z')) return '🗜️';
            if (mimetype.includes('text')) return '📄';

            return '📄';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        async function downloadFile(fileId, filename) {
            try {
                const response = await fetch(`${API_BASE_URL}/files/${fileId}/download`);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '下载失败');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showMessage(`文件 "${filename}" 下载完成`, 'success');

            } catch (error) {
                console.error('文件下载失败:', error);
                showMessage('文件下载失败: ' + error.message, 'error');
            }
        }

        async function deleteFile(fileId, filename, category) {
            try {
                if (!confirm(`确定要删除文件 "${filename}" 吗？`)) {
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/files/${fileId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`文件 "${filename}" 删除成功`, 'success');

                    // 重新加载文件列表
                    if (category) {
                        await loadCategoryFiles(category);
                    }
                } else {
                    showMessage(result.error || '删除文件失败', 'error');
                }

            } catch (error) {
                console.error('删除文件失败:', error);
                showMessage('删除文件失败: ' + error.message, 'error');
            }
        }

        // ============ 文件上传处理 ============
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, category) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files, category);
        }

        function handleFileSelect(e, category) {
            const files = e.target.files;
            handleFiles(files, category);
        }

        function handleFiles(files, category) {
            if (files.length === 0) return;

            // 检查文件数量
            if (files.length > 50) {
                showMessage('一次最多上传50个文件', 'error');
                return;
            }

            // 检查文件大小
            const maxSize = 100 * 1024 * 1024; // 100MB
            const oversizedFiles = [];

            for (let i = 0; i < files.length; i++) {
                if (files[i].size > maxSize) {
                    oversizedFiles.push(files[i].name);
                }
            }

            if (oversizedFiles.length > 0) {
                showMessage(`以下文件过大（超过100MB）：${oversizedFiles.join(', ')}`, 'error');
                return;
            }

            // 调试信息：显示文件原始名称
            console.log('准备上传的文件:');
            for (let i = 0; i < files.length; i++) {
                console.log(`文件 ${i + 1}: ${files[i].name} (${formatFileSize(files[i].size)})`);
            }

            // 根据类别上传文件
            if (category === 'project') {
                uploadProjectFiles(files);
            } else {
                uploadCategoryFiles(files, category);
            }
        }

        async function printResumeToFile(name) {
            var element = document.getElementById("cardContainer");
            var opt = {
                margin: 1,
                filename: `${name}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
            /*
            const opt = {
                margin: 10,
                filename: `${resume.name || 'resume'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            try {
                const pdfBlob = await html2pdf().from(element).set(opt).output('blob');
                const formData = new FormData();

            }*/
        }

        function viewCompanyDetails(company) {
            console.log("viewCompanyDetails clicked");
            console.log(document.getElementById("detailSideModal"))
            const sideModalContent = `
                <div style="display: flex; height: 100%;">
                    <div id="cardContainer" style="flex: 1; overflow-y: auto; background: #f8f9fa; border-radius: 8px; ">
                        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 100%;">
                            ${generateCompanyPreview(company)}
                        </div>
                    </div>
                    <button class="close-btn-side" onclick="closeSideModal()"> > </button>
                </div> 
            `;
            document.getElementById('sideModalBody').innerHTML = sideModalContent;
            document.getElementById('detailSideModal').style.display = 'flex';
            document.getElementById('detailSideModal').style.position = 'fixed';
        }

        function generateCompanyPreview(company) {
            return `
                <div style="min-height: 5vh; border-bottom: 2px solid #e8eaed; padding: 15px; margin-bottom: 15px; display: flex; align-items: center">
                    <img src="https://www.freelogodesign.org/assets/img/categories/32/logo-img-01.svg" 
                    alt="Tech Company Logo"
                    style="width: 100px; height: 100%; margin: 0 10px 0 0;">
                    <div style="display: flex; flex-direction: column;">
                        <h3 style="color: #1a73e8; margin-bottom: 15px;">
                            ${company}
                        </h3>
                        <div> 匹配公司： Lorem ipsum dolor sit amet  </div>
                    </div>
                </div>
                <h3 style="color: #1a73e8; margin-bottom: 15px;">
                    ℹ️ 公司簡介
                </h3> 
                <div style="margin-bottom: 15px;">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                    Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
                    Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                    Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                    Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
                    Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                    Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                    Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
                    Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                    Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </div>
                <h3 style="color: #1a73e8; margin-bottom: 15px;">
                    ✨ 工商消息
                </h3> 
                <div style="margin-bottom: 8px;"><strong>成立時間:</strong> </div>
                <div style="margin-bottom: 8px;"><strong>注冊資本:</strong> </div>
                <div style="margin-bottom: 8px;"><strong>法人代表:</strong> </div>
                <div style="margin-bottom: 8px;"><strong>所在地:</strong> </div>
                <div style="margin-bottom: 8px;"><strong>所屬行業:</strong> </div>
                <div style="margin-bottom: 8px;"><strong>企業類型:</strong> </div>
                
            `;
        }

        function viewDetails(id, file_id) {
            const resume = allResumes.find(r => r._id === id);
            if (!resume) return;

            currentDashboardFileId = file_id

            // 添加调试信息
            console.log('=== 查看详情调试信息 ===');
            console.log('简历ID:', id);
            console.log('简历数据:', resume);
            console.log('字段结构:', FIELD_STRUCTURE);
            console.log('字段分组:', FIELD_GROUPS);
            console.log('字段分组显示:', FIELD_GROUPS_DISPLAY);
            console.log('简历字段列表:', Object.keys(resume));
            console.log('dashboardid', currentDashboardFileId);

            // 左右分栏布局：左侧预览，右侧操作
            const modalContent = `
                <div style="display: flex; gap: 20px; height: 80vh;">
                    <!-- 左侧预览区域 -->
                    <div id="cardContainer" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            ${generateResumePreview(resume)}
                        </div>
                    </div>
                    <!-- 右侧操作区域 -->
                    <div style="width: 300px; display: flex; flex-direction: column; gap: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin-bottom: 15px; color: #1a73e8;">字段统计</h4>
                            <div style="font-size: 14px; color: #5f6368;">
                                <div>总字段数: ${Object.keys(resume).length}</div>
                                <div>基本信息: ${Object.keys(resume).filter(k => FIELD_GROUPS['basic_info'] && FIELD_GROUPS['basic_info'].includes(k)).length}</div>
                                <div>教育背景: ${Object.keys(resume).filter(k => FIELD_GROUPS['education'] && FIELD_GROUPS['education'].includes(k)).length}</div>
                                <div>工作经历: ${Object.keys(resume).filter(k => FIELD_GROUPS['work_experience'] && FIELD_GROUPS['work_experience'].includes(k)).length}</div>
                                <div>项目经验: ${Object.keys(resume).filter(k => FIELD_GROUPS['project_experience'] && FIELD_GROUPS['project_experience'].includes(k)).length}</div>
                                <div>个人技能: ${Object.keys(resume).filter(k => FIELD_GROUPS['skills'] && FIELD_GROUPS['skills'].includes(k)).length}</div>
                                <div>语言技能: ${Object.keys(resume).filter(k => FIELD_GROUPS['language_skills'] && FIELD_GROUPS['language_skills'].includes(k)).length}</div>
                                <div>证书奖项: ${Object.keys(resume).filter(k => FIELD_GROUPS['certificates'] && FIELD_GROUPS['certificates'].includes(k)).length}</div>
                                <div>培训经历: ${Object.keys(resume).filter(k => FIELD_GROUPS['training'] && FIELD_GROUPS['training'].includes(k)).length}</div>
                                <div>社会实践: ${Object.keys(resume).filter(k => FIELD_GROUPS['social_practice'] && FIELD_GROUPS['social_practice'].includes(k)).length}</div>
                                <div>个人评价: ${Object.keys(resume).filter(k => FIELD_GROUPS['self_evaluation'] && FIELD_GROUPS['self_evaluation'].includes(k)).length}</div>
                                <div>自定义字段: ${Object.keys(resume).filter(k => !Object.values(FIELD_GROUPS).flat().includes(k)).length}</div>
                            </div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin-bottom: 15px; color: #1a73e8;">操作</h4>
                            <button class="action-btn" onclick="editResume('${id}')" style="width: 100%; margin-bottom: 10px;">✏️ 编辑简历</button>
                            <button class="action-btn secondary" onclick="exportResume('${id}')" style="width: 100%; margin-bottom: 10px;">📄 导出数据</button>
                            <button class="action-btn danger" onclick="deleteResume('${id}')" style="width: 100%; margin-bottom: 10px;">🗑️ 删除简历</button>
                            <button class="action-btn secondary" onclick="printResumeToFile('${id}')" style="width: 100%; margin-bottom: 10px;" id="btnPrint">💾 下载简历 </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modalTitle').textContent = `${resume.name || '未知姓名'} - 简历详情`;
            document.getElementById('modalBody').innerHTML = modalContent;
            document.getElementById('detailModal').style.display = 'flex';
        }

        // 生成简历预览（使用自定义数据结构）
        function generateResumePreview(resume) {
            return `
                <!-- 个人信息头部 -->
                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e8eaed;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: #1a73e8; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 24px; font-weight: bold;">
                        ${resume.name ? resume.name.charAt(0) : 'U'}
                    </div>
                    <h2 style="margin-bottom: 10px; color: #202124;">${resume.name || '姓名未填写'}</h2>
                    <div style="display: flex; justify-content: center; gap: 20px; color: #5f6368; font-size: 14px;">
                        ${resume.phone || resume.mobile ? `<span>📞 ${resume.phone || resume.mobile}</span>` : ''}
                        ${resume.email ? `<span>📧 ${resume.email}</span>` : ''}
                        ${resume.living_address ? `<span>📍 ${resume.living_address}</span>` : ''}
                    </div>
                </div>

                ${generateAllSections(resume)}
            `;
        }

        // 生成所有分组内容
        function generateAllSections(resume) {
            let html = '';
            
            console.log('=== generateAllSections 调试信息 ===');
            console.log('简历数据:', resume);
            console.log('FIELD_GROUPS_DISPLAY:', FIELD_GROUPS_DISPLAY);
            
            // 按分组顺序生成内容
            const sortedGroups = Object.entries(FIELD_GROUPS_DISPLAY)
                .sort((a, b) => a[1].order - b[1].order);
            
            console.log('排序后的分组:', sortedGroups);
            
            for (const [groupKey, groupConfig] of sortedGroups) {
                console.log(`处理分组: ${groupKey}`, groupConfig);
                const sectionHtml = generateSectionByGroup(groupKey, resume);
                console.log(`分组 ${groupKey} 生成的HTML:`, sectionHtml ? '有内容' : '无内容');
                if (sectionHtml) {
                    html += sectionHtml;
                }
            }
            
            // 生成未分组字段
            const otherFieldsHtml = generateOtherFieldsSection(resume);
            if (otherFieldsHtml) {
                html += otherFieldsHtml;
            }
            
            console.log('最终生成的HTML长度:', html.length);
            return html;
        }

        // 根据分组生成内容
        function generateSectionByGroup(groupKey, resume) {
            const groupConfig = FIELD_GROUPS_DISPLAY[groupKey];
            const fields = FIELD_GROUPS[groupKey] || [];
            
            console.log(`=== generateSectionByGroup 调试信息 (${groupKey}) ===`);
            console.log('groupConfig:', groupConfig);
            console.log('fields:', fields);
            
            if (!groupConfig) {
                console.log(`分组 ${groupKey} 没有配置，跳过`);
                return '';
            }
            
            // 检查是否有数据
            const hasData = fields.some(field => resume[field] !== undefined && resume[field] !== null && resume[field] !== '');
            console.log(`分组 ${groupKey} 普通字段有数据:`, hasData);
            
            // 对于数组类型的字段，检查是否有数据
            const arrayFields = ['work_experience', 'project_experience', 'skills', 'language_skills', 'certificates', 'training', 'social_practice'];
            const hasArrayData = arrayFields.includes(groupKey) && Array.isArray(resume[groupKey]) && resume[groupKey].length > 0;
            console.log(`分组 ${groupKey} 数组字段有数据:`, hasArrayData, resume[groupKey]);
            
            if (!hasData && !hasArrayData) {
                console.log(`分组 ${groupKey} 没有数据，跳过`);
                return '';
            }
            
            let html = `<div style="margin-bottom: 30px;"><h3 style="color: #1a73e8; margin-bottom: 15px;">${groupConfig.icon} ${groupConfig.name}</h3>`;
            
            // 根据分组类型生成不同的内容
            switch (groupKey) {
                case 'work_experience':
                    html += generateWorkExperienceSection(resume.work_experience);
                    break;
                case 'project_experience':
                    html += generateProjectExperienceSection(resume.project_experience);
                    break;
                case 'skills':
                    html += generateSkillsSection(resume.skills);
                    break;
                case 'language_skills':
                    html += generateLanguageSkillsSection(resume.language_skills);
                    break;
                case 'certificates':
                    html += generateCertificatesSection(resume.certificates);
                    break;
                case 'training':
                    html += generateTrainingSection(resume.training);
                    break;
                case 'social_practice':
                    html += generateSocialPracticeSection(resume.social_practice);
                    break;
                default:
                    // 普通字段组
                    html += generateSimpleFieldsSection(fields, resume);
                    break;
            }
            
            html += '</div>';
            console.log(`分组 ${groupKey} 最终HTML长度:`, html.length);
            return html;
        }

        // 生成简单字段组
        function generateSimpleFieldsSection(fields, resume) {
            let html = '';
            fields.forEach(field => {
                if (resume[field] !== undefined && resume[field] !== null && resume[field] !== '') {
                    const fieldConfig = getFieldConfig(field);
                    const label = fieldConfig ? fieldConfig.label : field;
                    html += `<div style="margin-bottom: 8px;"><strong>${label}:</strong> ${resume[field]}</div>`;
                }
            });
            return html;
        }

        // 获取字段配置
        function getFieldConfig(fieldName) {
            for (const [groupKey, fields] of Object.entries(FIELD_STRUCTURE)) {
                if (fields[fieldName]) {
                    return fields[fieldName];
                }
            }
            return null;
        }

        // 生成工作经历部分
        function generateWorkExperienceSection(workExperience) {
            if (!Array.isArray(workExperience) || workExperience.length === 0) return '';
            
            return workExperience.map(work => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #34a853;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #202124;">${work.job_position || '职位未填写'}</div>
                        <span style="background: #34a853; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">工作</span>
                    </div>
                    <div style="color: #5f6368; margin-bottom: 8px;">
                        🏢 <a onclick="viewCompanyDetails('${work.company_name || '公司未填写'}')" style="color: #5f6368; text-decoration: underline; cursor: pointer;">
                        ${work.company_name || '公司未填写'}
                        </a>
                    </div>
                    ${work.department_name ? `<div style="color: #5f6368; margin-bottom: 8px;">🏢 ${work.department_name}</div>` : ''}
                    <div style="color: #5f6368; margin-bottom: 8px; font-size: 12px;">📅 ${work.work_start_time || ''} - ${work.work_end_time || ''}</div>
                    ${work.salary ? `<div style="color: #5f6368; margin-bottom: 8px;">💰 ${work.salary}</div>` : ''}
                    ${work.industry ? `<div style="color: #5f6368; margin-bottom: 8px;">🏭 ${work.industry}</div>` : ''}
                    ${work.work_desc ? `<div style="line-height: 1.6; color: #202124;">${work.work_desc}</div>` : ''}
                    ${work.achievement ? `<div style="line-height: 1.6; color: #202124; margin-top: 8px;"><strong>工作成就:</strong> ${work.achievement}</div>` : ''}
                </div>
            `).join('');
        }

        // 生成项目经验部分
        function generateProjectExperienceSection(projectExperience) {
            if (!Array.isArray(projectExperience) || projectExperience.length === 0) return '';
            
            return projectExperience.map(project => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1a73e8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #202124;">${project.project_name || '项目未填写'}</div>
                        <span style="background: #1a73e8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">项目</span>
                    </div>
                    <div style="color: #5f6368; margin-bottom: 8px;">👤 ${project.project_role || '角色未填写'}</div>
                    <div style="color: #5f6368; margin-bottom: 8px; font-size: 12px;">📅 ${project.project_start_time || ''} - ${project.project_end_time || ''}</div>
                    ${project.project_technology ? `<div style="color: #5f6368; margin-bottom: 8px;">💻 ${project.project_technology}</div>` : ''}
                    ${project.project_scale ? `<div style="color: #5f6368; margin-bottom: 8px;">📊 ${project.project_scale}</div>` : ''}
                    ${project.project_desc ? `<div style="line-height: 1.6; color: #202124; margin-bottom: 8px;">${project.project_desc}</div>` : ''}
                    ${project.project_content ? `<div style="line-height: 1.6; color: #5f6368; font-size: 14px; margin-bottom: 8px;">${project.project_content}</div>` : ''}
                    ${project.project_result ? `<div style="line-height: 1.6; color: #202124;"><strong>项目成果:</strong> ${project.project_result}</div>` : ''}
                </div>
            `).join('');
        }

        // 生成技能部分
        function generateSkillsSection(skills) {
            if (!Array.isArray(skills) || skills.length === 0) return '';
            
            return `<div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${skills.map(skill => 
                    `<span style="background: #e8f0fe; color: #1a73e8; padding: 6px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #dadce0;">
                        ${skill.skill_name}${skill.skill_level ? ` - ${skill.skill_level}` : ''}${skill.skill_years ? ` (${skill.skill_years}年)` : ''}
                    </span>`
                ).join('')}
            </div>`;
        }

        // 生成证书部分
        function generateCertificatesSection(certificates) {
            if (!Array.isArray(certificates) || certificates.length === 0) return '';
            
            return certificates.map(cert => `
                <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #ff9800;">
                    <div style="font-weight: 600; color: #202124;">${cert.award_info || '证书未填写'}</div>
                    <div style="color: #5f6368; font-size: 12px;">📅 ${cert.award_time || ''}</div>
                    ${cert.award_level ? `<div style="color: #5f6368; font-size: 12px;">🏆 ${cert.award_level}</div>` : ''}
                    ${cert.award_issuer ? `<div style="color: #5f6368; font-size: 12px;">🏛️ ${cert.award_issuer}</div>` : ''}
                    ${cert.award_desc ? `<div style="color: #5f6368; margin-top: 4px;">${cert.award_desc}</div>` : ''}
                </div>
            `).join('');
        }

        // 生成培训部分
        function generateTrainingSection(training) {
            if (!Array.isArray(training) || training.length === 0) return '';
            
            return training.map(train => `
                <div style="background: #f3e5f5; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #9c27b0;">
                    <div style="font-weight: 600; color: #202124;">${train.training_name || '培训未填写'}</div>
                    <div style="color: #5f6368; font-size: 12px;">📅 ${train.training_time || ''}</div>
                    ${train.training_institution ? `<div style="color: #5f6368; font-size: 12px;">🏫 ${train.training_institution}</div>` : ''}
                    ${train.training_duration ? `<div style="color: #5f6368; font-size: 12px;">⏱️ ${train.training_duration}</div>` : ''}
                    ${train.training_desc ? `<div style="color: #5f6368; margin-top: 4px;">${train.training_desc}</div>` : ''}
                </div>
            `).join('');
        }

        // 生成语言技能部分
        function generateLanguageSkillsSection(languageSkills) {
            if (!Array.isArray(languageSkills) || languageSkills.length === 0) return '';
            
            return `<div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${languageSkills.map(lang => 
                    `<span style="background: #e8f5e8; color: #2e7d32; padding: 6px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #c8e6c9;">
                        ${lang.language_name}${lang.language_level ? ` - ${lang.language_level}` : ''}${lang.language_score ? ` (${lang.language_score})` : ''}
                    </span>`
                ).join('')}
            </div>`;
        }

        // 生成社会实践部分
        function generateSocialPracticeSection(socialPractice) {
            if (!Array.isArray(socialPractice) || socialPractice.length === 0) return '';
            
            return socialPractice.map(practice => `
                <div style="background: #f1f8e9; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #8bc34a;">
                    <div style="font-weight: 600; color: #202124;">${practice.practice_name || '实践未填写'}</div>
                    <div style="color: #5f6368; font-size: 12px;">📅 ${practice.practice_time || ''}</div>
                    ${practice.practice_role ? `<div style="color: #5f6368; font-size: 12px;">👤 ${practice.practice_role}</div>` : ''}
                    ${practice.practice_organization ? `<div style="color: #5f6368; font-size: 12px;">🏢 ${practice.practice_organization}</div>` : ''}
                    ${practice.practice_desc ? `<div style="color: #5f6368; margin-top: 4px;">${practice.practice_desc}</div>` : ''}
                </div>
            `).join('');
        }

        // 生成未分组字段部分
        function generateOtherFieldsSection(resume) {
            const allGrouped = new Set(Object.values(FIELD_GROUPS).flat());
            const otherFields = Object.entries(resume)
                .filter(([key, value]) => !allGrouped.has(key) && value !== undefined && value !== null && value !== '')
                .map(([key, value]) => {
                    let display = value;
                    if (typeof value === 'object') {
                        display = `<pre style="white-space:pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px;">${JSON.stringify(value, null, 2)}</pre>`;
                    }
                    return `<div style="margin-bottom: 8px;"><strong>${key}:</strong> ${display}</div>`;
                }).join('');
            
            if (!otherFields) return '';
            
            return `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1a73e8; margin-bottom: 15px;">📝 其他信息</h3>
                    ${otherFields}
                </div>
            `;
        }

        // 编辑弹窗改为分组折叠式
        function editResume(id) {
            const resume = allResumes.find(r => r._id === id);
            if (!resume) return;

            // 构建分组折叠式表单
            let formHtml = '<form id="editResumeForm">';
            
            // 按分组渲染字段
            for (const [groupName, fields] of Object.entries(FIELD_GROUPS)) {
                let groupFields = '';
                fields.forEach(key => {
                    if (resume[key] !== undefined) {
                        groupFields += generateFieldInput(key, resume[key]);
                    }
                });
                
                if (groupFields) {
                    const displayName = GROUP_NAME_MAP[groupName] || groupName;
                    formHtml += `
                        <div class="field-group" style="margin-bottom: 20px; border: 1px solid #e8eaed; border-radius: 8px; overflow: hidden;">
                            <div class="group-header" style="background: #f8f9fa; padding: 12px 16px; cursor: pointer; font-weight: 600; color: #1a73e8;" onclick="toggleGroup(this)">
                                <span style="margin-right: 8px;">📁</span>${displayName}
                                <span class="toggle-icon" style="float: right;">▼</span>
                            </div>
                            <div class="group-content" style="padding: 16px;">
                                ${groupFields}
                            </div>
                        </div>
                    `;
                }
            }
            
            // 添加字段按钮
            formHtml += `
                <div style="margin-bottom: 20px; text-align: center;">
                    <button type="button" class="btn-small primary" onclick="addField()">+ 添加自定义字段</button>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="action-btn">💾 保存</button>
                    <button type="button" class="action-btn secondary" style="margin-left: 10px;" onclick="closeModal()">❌ 取消</button>
                </div>
            </form>`;

            document.getElementById('modalTitle').textContent = '✏️ 编辑简历';
            document.getElementById('modalBody').innerHTML = formHtml;
            document.getElementById('detailModal').style.display = 'flex';

            // 表单提交事件（保持原有逻辑）
            document.getElementById('editResumeForm').onsubmit = async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = {};
                
                // 调试信息
                console.log('表单提交 - 原始数据:', resume);
                
                for (const [k, v] of formData.entries()) {
                    let value = v;
                    
                    // 调试信息
                    console.log(`处理字段: ${k}`, {
                        originalValue: v,
                        originalType: typeof v,
                        resumeFieldType: typeof resume[k],
                        resumeFieldValue: resume[k]
                    });
                    
                    // 尝试解析JSON
                    if (v.trim() !== '') {
                        try {
                            value = JSON.parse(v);
                            console.log(`JSON解析成功: ${k}`, value);
                        } catch (e) {
                            // JSON解析失败，检查原始字段类型
                            if (Array.isArray(resume[k])) {
                                console.log(`字段 ${k} 应为数组，但输入不是有效JSON，设为空数组`);
                                value = [];
                            } else if (typeof resume[k] === 'object' && resume[k] !== null) {
                                console.log(`字段 ${k} 应为对象，但输入不是有效JSON`);
                                alert(`字段 ${k} 请输入合法的 JSON 格式！\n\n当前输入: ${v}\n\n错误信息: ${e.message}`);
                                return;
                            } else {
                                // 普通字符串字段，保持原值
                                value = v;
                                console.log(`字段 ${k} 保持字符串值:`, value);
                            }
                        }
                    } else {
                        // 空值处理
                        if (Array.isArray(resume[k])) {
                            value = [];
                        } else if (typeof resume[k] === 'object' && resume[k] !== null) {
                            value = {};
                        } else {
                            value = '';
                        }
                    }
                    
                    data[k] = value;
                }
                
                // 处理邮箱字段别名
                if (data['邮箱'] && !data['email']) {
                    data['email'] = data['邮箱'];
                    delete data['邮箱'];
                }
                
                // 合并未修改的字段
                Object.entries(resume).forEach(([k, v]) => {
                    if (k === '_id') return;
                    if (!(k in data)) {
                        data[k] = v;
                    }
                });
                
                // 调试信息
                console.log('提交的数据:', data);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/resume/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage('简历更新成功', 'success');
                        closeModal();
                        await loadData();
                    } else {
                        showMessage(result.error || '更新失败', 'error');
                    }
                } catch (error) {
                    showMessage('更新失败: ' + error.message, 'error');
                }
            };
        }

        // 生成字段输入控件
        function generateFieldInput(key, value) {
            let inputHtml = '';
            
            // 调试信息
            console.log(`生成字段输入: ${key}`, {
                value: value,
                type: typeof value,
                isArray: Array.isArray(value),
                isObject: typeof value === 'object' && value !== null,
                constructor: value?.constructor?.name
            });
            
            // 检查是否为复杂数据类型（对象、数组）
            if (typeof value === 'object' && value !== null) {
                // 对象或数组类型，使用textarea显示JSON
                const jsonString = JSON.stringify(value, null, 2);
                inputHtml = `<textarea name="${key}" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;min-height:80px;font-family:monospace;" placeholder="请输入合法JSON格式">${jsonString}</textarea>`;
            } else if (typeof value === 'string' && (value.startsWith('[') || value.startsWith('{'))) {
                // 可能是JSON字符串，尝试解析
                try {
                    const parsed = JSON.parse(value);
                    const jsonString = JSON.stringify(parsed, null, 2);
                    inputHtml = `<textarea name="${key}" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;min-height:80px;font-family:monospace;" placeholder="请输入合法JSON格式">${jsonString}</textarea>`;
                } catch (e) {
                    // 解析失败，当作普通字符串处理
                    inputHtml = `<input type="text" name="${key}" value="${value !== undefined ? value : ''}" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;" />`;
                }
            } else {
                // 普通类型，使用input
                inputHtml = `<input type="text" name="${key}" value="${value !== undefined ? value : ''}" style="width:100%;padding:8px;border:1px solid #dadce0;border-radius:4px;" />`;
            }
            
            return `
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #5f6368;">${key}:</label>
                    ${inputHtml}
                </div>
            `;
        }

        // 分组折叠/展开
        function toggleGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        // 导出简历数据
        function exportResume(id) {
            const resume = allResumes.find(r => r._id === id);
            if (!resume) return;
            
            const dataStr = JSON.stringify(resume, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${resume.name || 'resume'}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showMessage('简历数据导出成功', 'success');
        }

        // 添加字段时支持类型选择和分组
        function addField() {
            const form = document.getElementById('editResumeForm');
            const div = document.createElement('div');
            div.style = 'display:flex;align-items:center;margin-bottom:10px;gap:8px;';
            div.innerHTML = `
                <input type="text" placeholder="字段名(建议英文小写)" style="min-width:90px;padding:6px 8px;border:1px solid #dadce0;border-radius:4px;" oninput="this.nextElementSibling.name=this.value" />
                <select style="padding:6px 8px;border:1px solid #dadce0;border-radius:4px;" onchange="updateFieldInputType(this)">
                    <option value="text">文本</option>
                    <option value="number">数字</option>
                    <option value="date">日期</option>
                    <option value="json">JSON</option>
                </select>
                <input type="text" placeholder="字段值" style="flex:1;padding:6px 8px;border:1px solid #dadce0;border-radius:4px;" />
                <select style="padding:6px 8px;border:1px solid #dadce0;border-radius:4px;" name="group">
                    <option value="其他">其他</option>
                    <option value="基本信息">基本信息</option>
                    <option value="教育经历">教育经历</option>
                    <option value="工作经历">工作经历</option>
                    <option value="项目经历">项目经历</option>
                    <option value="技能列表">技能列表</option>
                    <option value="语言技能">语言技能</option>
                    <option value="证书奖项">证书奖项</option>
                    <option value="培训经历">培训经历</option>
                    <option value="社会实践">社会实践</option>
                    <option value="个人评价">个人评价</option>
                </select>
                <button type="button" class="btn-small danger" onclick="removeField(this)">删除</button>
            `;
            // 字段名唯一性校验
            div.querySelector('input[placeholder^="字段名"]').addEventListener('blur', function() {
                const fieldName = this.value.trim();
                if (fieldName && form.querySelector(`[name="${fieldName}"]`)) {
                    alert('该字段已存在，请勿重复添加！');
                    this.value = '';
                }
            });
            form.insertBefore(div, form.children[form.children.length-2]);
        }

        // 字段类型切换时渲染不同输入控件
        function updateFieldInputType(select) {
            const input = select.parentElement.querySelector('input[placeholder^="字段值"]');
            if (!input) return;
            const type = select.value;
            if (type === 'json') {
                const textarea = document.createElement('textarea');
                textarea.placeholder = '请输入合法JSON，如 [ {...} ]';
                textarea.style = input.style.cssText + ';min-height:60px;';
                textarea.name = input.name;
                input.parentElement.replaceChild(textarea, input);
            } else {
                const newInput = document.createElement('input');
                newInput.type = type;
                newInput.placeholder = '字段值';
                newInput.style = input.style.cssText;
                newInput.name = input.name;
                input.parentElement.replaceChild(newInput, input);
            }
        }

        // 删除字段
        function removeField(btn, key) {
            const div = btn.parentElement;
            div.remove();
        }

        function deleteResume(id) {
            if (!confirm('确定要删除这份简历吗？')) return;
            fetch(`${API_BASE_URL}/resume/${id}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(result => {
                if (result.message) {
                    showMessage('简历删除成功', 'success');
                    loadData();
                } else {
                    showMessage(result.error || '删除失败', 'error');
                }
            })
            .catch(err => {
                showMessage('删除失败: ' + err.message, 'error');
            });
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function closeSideModal() {
            document.getElementById('detailSideModal').style.display = 'none';
        }

        function showProjectManager() {
            renderProjectManagerList();
            document.getElementById('projectManagerModal').style.display = 'flex';
        }

        function closeProjectManager() {
            document.getElementById('projectManagerModal').style.display = 'none';
            document.getElementById('newProjectNameInput').value = '';
            document.getElementById('newProjectDescInput').value = '';
        }

        function renderProjectManagerList() {
            const listContainer = document.getElementById('projectManagerList');
            if (!listContainer) return;

            if (allProjects.length === 0) {
                listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">暂无项目</p>';
                return;
            }

            listContainer.innerHTML = allProjects.map(project => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e8eaed; border-radius: 6px; margin-bottom: 8px; ${project._id === currentProject ? 'background: #e8f0fe; border-color: #1a73e8;' : ''}">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 2px; display: flex; align-items: center; gap: 8px;">
                            <span id="projectNameDisplay-${project._id}">${project.name}</span>
                            <input id="projectNameInput-${project._id}" type="text" value="${project.name}" style="display:none; padding:2px 6px; font-size:14px; border:1px solid #dadce0; border-radius:4px; min-width:80px;" onkeydown="handleProjectNameEdit(event, '${project._id}')" />
                            <button class="btn-small" onclick="showProjectNameEdit('${project._id}')">编辑名称</button>
                        </div>
                        <div style="font-size: 12px; color: #5f6368;">${project.description || '暂无描述'}</div>
                        <div style="font-size: 11px; color: #5f6368; margin-top: 2px;">创建时间: ${formatDate(project.created_at)}</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${project._id === currentProject ? '<span style="color: #1a73e8; font-size: 12px; margin-right: 8px;">当前</span>' : ''}
                        <button class="btn-small" onclick="switchProject('${project._id}')" ${project._id === currentProject ? 'disabled' : ''}>
                            ${project._id === currentProject ? '已选择' : '选择'}
                        </button>
                        <button class="btn-small danger" onclick="deleteProject('${project._id}')">删除</button>
                    </div>
                </div>
            `).join('');
        }

        async function createProjectFromModal() {
            const nameInput = document.getElementById('newProjectNameInput');
            const descInput = document.getElementById('newProjectDescInput');

            const name = nameInput.value.trim();
            const description = descInput.value.trim();

            if (!name) {
                showMessage('请输入项目名称', 'error');
                nameInput.focus();
                return;
            }

            const success = await createProject(name, description);
            if (success) {
                nameInput.value = '';
                descInput.value = '';
                renderProjectManagerList();
            }
        }

        async function deleteProject(projectId) {
            try {
                const project = allProjects.find(p => p._id === projectId);
                const projectName = project ? project.name : '项目';

                if (!confirm(`确定要删除项目 "${projectName}" 吗？\n\n删除后将同时删除项目中的所有文件，此操作不可恢复。`)) {
                    return false;
                }

                const response = await fetch(`${API_BASE_URL}/projects/${projectId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`项目 "${projectName}" 删除成功`, 'success');

                    if (currentProject === projectId) {
                        currentProject = null;
                    }

                    await loadProjects();

                    if (allProjects.length > 0) {
                        switchProject(allProjects[0]._id);
                    } else {
                        currentProject = null;
                        switchPage('dashboard');
                    }

                    return true;
                } else {
                    showMessage(result.error || '删除项目失败', 'error');
                    return false;
                }

            } catch (error) {
                console.error('删除项目失败:', error);
                showMessage('删除项目失败: ' + error.message, 'error');
                return false;
            }
        }

        async function testConnection() {
            try {
                showMessage('正在测试连接...', 'info');
                const response = await fetch(`${API_BASE_URL}/health`);

                if (response.ok) {
                    showMessage('API连接正常', 'success');
                } else {
                    showMessage('API连接失败', 'error');
                }
            } catch (error) {
                showMessage('连接测试失败: ' + error.message, 'error');
            }
        }

        async function testAllEndpoints() {
            const endpoints = [
                { url: `${API_BASE_URL}/health`, name: '健康检查' },
                { url: `${API_BASE_URL}/resume/all`, name: '获取所有简历' },
                { url: `${API_BASE_URL}/resume/latest`, name: '获取最新简历' },
                { url: `${API_BASE_URL}/projects`, name: '获取项目列表' },
                { url: `${API_BASE_URL}/system/info`, name: '系统信息' }
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    const status = response.ok ? '✅' : '❌';
                    showMessage(`${status} ${endpoint.name}: ${response.status}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    showMessage(`❌ ${endpoint.name}: 连接失败`, 'error');
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        async function getSystemInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/system/info`);
                const data = await response.json();

                if (response.ok) {
                    let infoHtml = `
                        <h4>系统信息</h4>
                        <div class="info-row"><strong>数据目录:</strong> ${data.data_directory}</div>
                        <div class="info-row"><strong>项目数量:</strong> ${data.project_count}</div>
                        <div class="info-row"><strong>项目文件数:</strong> ${data.project_file_count}</div>
                        <div class="info-row"><strong>磁盘使用:</strong> ${data.total_disk_usage_mb} MB</div>
                        <br>
                        <h4>文件分类统计</h4>
                    `;

                    Object.entries(data.file_categories).forEach(([category, info]) => {
                        infoHtml += `<div class="info-row"><strong>${info.name}:</strong> ${info.count} 个文件</div>`;
                    });

                    document.getElementById('modalTitle').textContent = '系统信息';
                    document.getElementById('modalBody').innerHTML = infoHtml;
                    document.getElementById('detailModal').style.display = 'flex';
                } else {
                    showMessage('获取系统信息失败', 'error');
                }
            } catch (error) {
                showMessage('获取系统信息失败: ' + error.message, 'error');
            }
        }

        async function refreshData() {
            await loadData();
            updateStats();

            // 刷新当前页面的文件列表
            if (currentPage.startsWith('upload-')) {
                const category = currentPage.replace('upload-', '');
                if (FILE_CATEGORIES[category]) {
                    loadCategoryFiles(category);
                }
            } else if (currentPage === 'project-upload') {
                loadProjectFiles();
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(filteredResumes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `简历数据_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showMessage('数据导出成功', 'success');
        }

        function loadResumeManagement() {
            const managementGrid = document.getElementById('resumeManagementGrid');
            const originalGrid = document.getElementById('resumeGrid');
            if (managementGrid && originalGrid) {
                managementGrid.innerHTML = originalGrid.innerHTML;
            }
        }

        async function checkConnectionStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const statusElement = document.getElementById('connectionStatus');

                if (statusElement) {
                    if (response.ok) {
                        statusElement.textContent = '✅ 连接正常';
                        statusElement.style.color = '#34a853';
                    } else {
                        statusElement.textContent = '❌ 连接异常';
                        statusElement.style.color = '#ea4335';
                    }
                }
            } catch (error) {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    statusElement.textContent = '❌ 连接失败';
                    statusElement.style.color = '#ea4335';
                }
            }
        }

        function showMessage(message, type) {
            const messageElement = document.getElementById('statusMessage');
            messageElement.textContent = message;
            messageElement.className = `status-message ${type} show`;

            setTimeout(() => {
                messageElement.classList.remove('show');
            }, 3000);
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeSideModal();
            }
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });

        function showProjectNameEdit(projectId) {
            document.getElementById(`projectNameDisplay-${projectId}`).style.display = 'none';
            const input = document.getElementById(`projectNameInput-${projectId}`);
            input.style.display = 'inline-block';
            input.focus();
            input.select();
        }

        async function handleProjectNameEdit(event, projectId) {
            const input = document.getElementById(`projectNameInput-${projectId}`);
            if (event.key === 'Enter') {
                const newName = input.value.trim();
                if (!newName) {
                    showMessage('项目名称不能为空', 'error');
                    return;
                }
                // 调用后端API
                try {
                    const response = await fetch(`${API_BASE_URL}/projects/${projectId}/name`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage('项目名称修改成功', 'success');
                        await loadProjects();
                    } else {
                        showMessage(result.error || '修改失败', 'error');
                    }
                } catch (error) {
                    showMessage('修改失败: ' + error.message, 'error');
                }
                input.style.display = 'none';
                document.getElementById(`projectNameDisplay-${projectId}`).style.display = 'inline';
            } else if (event.key === 'Escape') {
                input.style.display = 'none';
                document.getElementById(`projectNameDisplay-${projectId}`).style.display = 'inline';
            }
        }

        function showSidebarProjectNameEdit(projectId) {
            document.getElementById(`sidebarProjectNameDisplay-${projectId}`).style.display = 'none';
            const input = document.getElementById(`sidebarProjectNameInput-${projectId}`);
            input.style.display = 'inline-block';
            input.focus();
            input.select();
        }

        async function handleSidebarProjectNameEdit(event, projectId) {
            const input = document.getElementById(`sidebarProjectNameInput-${projectId}`);
            if (event.key === 'Enter') {
                const newName = input.value.trim();
                if (!newName) {
                    showMessage('项目名称不能为空', 'error');
                    return;
                }
                // 调用后端API
                try {
                    const response = await fetch(`${API_BASE_URL}/projects/${projectId}/name`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage('项目名称修改成功', 'success');
                        await loadProjects();
                    } else {
                        showMessage(result.error || '修改失败', 'error');
                    }
                } catch (error) {
                    showMessage('修改失败: ' + error.message, 'error');
                }
                input.style.display = 'none';
                document.getElementById(`sidebarProjectNameDisplay-${projectId}`).style.display = 'inline';
            } else if (event.key === 'Escape') {
                input.style.display = 'none';
                document.getElementById(`sidebarProjectNameDisplay-${projectId}`).style.display = 'inline';
            }
        }

        async function parseResumeFileAndRefresh(fileId, filename) {
            try {
                showMessage(`开始解析简历: ${filename}`, 'info');
                const response = await fetch(`${API_BASE_URL}/files/${fileId}/parse`, { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    showMessage(`简历解析完成: ${filename}`, 'success');
                    await loadData(); // 刷新仪表板和简历管理
                } else {
                    showMessage(result.error || '解析失败', 'error');
                }
            } catch (error) {
                showMessage('解析失败: ' + error.message, 'error');
            }
        }

        // 在<script>标签内添加：
        const CHAT_API_BASE = 'http://localhost:5000/api/v1';
        const CHAT_API_KEY = 'ragflow-JkN2JmM2M4NjUyYjExZjA5Yjc2MDI0Mm';
        // const CHAT_ID = '58d5d9c0654911f082290242ac120003';
        const CHAT_ID = '37a232fc651d11f0a5160242ac120003';
        let chatSessions = [];
        let currentSessionId = null;
        let currentSessionMessages = [];

        // RAG配置相关变量
        let selectedDatasetId = null;
        let ragConfig = {
            apiUrl: 'http://localhost/api/v1',
            apiKey: '',
            selectedDataset: null
        };

        // 加载RAG配置
        function loadRagConfig() {
            const saved = localStorage.getItem('ragConfig');
            if (saved) {
                ragConfig = JSON.parse(saved);
                document.getElementById('ragApiUrl').value = ragConfig.apiUrl || 'http://localhost/api/v1';
                document.getElementById('ragApiKey').value = ragConfig.apiKey || '';
                document.getElementById('syncMethod').value = ragConfig.syncMethod || 'auto';
                selectedDatasetId = ragConfig.selectedDataset;
                updateSelectedDatasetDisplay();
            }
        }

        // 保存RAG配置
        function saveRagConfig() {
            ragConfig.apiUrl = document.getElementById('ragApiUrl').value.trim();
            ragConfig.apiKey = document.getElementById('ragApiKey').value.trim();
            ragConfig.syncMethod = document.getElementById('syncMethod').value;
            ragConfig.selectedDataset = selectedDatasetId;
            
            localStorage.setItem('ragConfig', JSON.stringify(ragConfig));
            showMessage('RAG配置已保存', 'success');
        }

        // 测试RAG连接
        async function testRagConnection() {
            try {
                const apiUrl = document.getElementById('ragApiUrl').value.trim();
                const apiKey = document.getElementById('ragApiKey').value.trim();
                
                if (!apiUrl || !apiKey) {
                    showMessage('请填写完整的API地址和密钥', 'error');
                    return;
                }

                console.log('=== 测试RAG连接 ===');
                console.log('API地址:', apiUrl);
                console.log('API密钥:', apiKey.substring(0, 10) + '...');

                const response = await fetch(`${apiUrl}/datasets`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('连接测试响应状态:', response.status);
                console.log('连接测试响应头:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const data = await response.json();
                    console.log('知识库列表:', data);
                    showMessage('RAG连接测试成功', 'success');
                } else {
                    const errorData = await response.json();
                    console.error('连接测试失败:', errorData);
                    showMessage('RAG连接测试失败', 'error');
                }
            } catch (error) {
                console.error('连接测试异常:', error);
                showMessage('连接测试失败: ' + error.message, 'error');
            }
        }

        // 测试RAG API文档上传格式
        async function testRagDocumentUpload() {
            try {
                const apiUrl = document.getElementById('ragApiUrl').value.trim();
                const apiKey = document.getElementById('ragApiKey').value.trim();
                
                if (!apiUrl || !apiKey) {
                    showMessage('请填写完整的API地址和密钥', 'error');
                    return;
                }

                if (!selectedDatasetId) {
                    showMessage('请先选择目标知识库', 'error');
                    return;
                }

                console.log('=== 测试RAG文档上传格式 ===');
                console.log('API地址:', apiUrl);
                console.log('知识库ID:', selectedDatasetId);

                // 创建一个测试文件
                const testContent = '这是一个测试文档，用于验证RAG API的文档上传功能。';
                const testBlob = new Blob([testContent], { type: 'text/plain' });
                const formData = new FormData();
                formData.append('file', testBlob, 'test.txt');
                formData.append('dataset_id', selectedDatasetId);

                console.log('测试文件大小:', testBlob.size, '字节');

                const response = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                console.log('上传测试响应状态:', response.status);
                console.log('上传测试响应头:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const data = await response.json();
                    console.log('上传测试成功:', data);
                    showMessage('RAG文档上传格式测试成功', 'success');
                } else {
                    const errorData = await response.json();
                    console.error('上传测试失败:', errorData);
                    showMessage(`RAG文档上传格式测试失败: ${errorData.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('上传测试异常:', error);
                showMessage('上传测试失败: ' + error.message, 'error');
            }
        }

        // 加载知识库列表
        async function loadDatasets() {
            try {
                const apiUrl = document.getElementById('ragApiUrl').value.trim();
                const apiKey = document.getElementById('ragApiKey').value.trim();
                
                if (!apiUrl || !apiKey) {
                    showMessage('请先配置RAG API地址和密钥', 'error');
                    return;
                }

                // 显示加载状态
                const container = document.getElementById('datasetsList');
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        正在加载知识库列表...
                    </div>
                `;

                /* 添加测试数据用于验证显示效果
                const testDatasets = [
                    {
                        id: 'dataset-1',
                        name: 'A公司知识库',
                        description: 'A公司的企业知识库，包含公司介绍、产品信息等',
                        status: 'active',
                        document_count: 15
                    },
                    {
                        id: 'dataset-2',
                        name: '个人简历库',
                        description: '存储个人简历信息，用于AI分析和推荐',
                        status: 'active',
                        document_count: 8
                    },
                    {
                        id: 'dataset-3',
                        name: '英语测试库',
                        description: '英语学习相关的文档和测试材料',
                        status: 'active',
                        document_count: 12
                    },
                    {
                        id: 'dataset-4',
                        name: '技术文档库',
                        description: '技术文档和开发指南',
                        status: 'inactive',
                        document_count: 25
                    }
                ];

                // 使用测试数据渲染
                renderDatasetsList(testDatasets);
                showMessage(`成功加载 ${testDatasets.length} 个知识库`, 'success');
*/
                // 注释掉实际的API调用，使用测试数据
                
                const response = await fetch(`${apiUrl}/datasets`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    renderDatasetsList(result.data || []);
                    showMessage(`成功加载 ${result.data?.length || 0} 个知识库`, 'success');
                } else {
                    const errorData = await response.json();
                    container.innerHTML = `
                        <div class="datasets-empty">
                            <div>加载失败</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #ea4335;">
                                ${errorData.error || '未知错误'}
                            </div>
                        </div>
                    `;
                    showMessage('加载知识库列表失败', 'error');
                }
                
            } catch (error) {
                const container = document.getElementById('datasetsList');
                container.innerHTML = `
                    <div class="datasets-empty">
                        <div>连接失败</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #ea4335;">
                            ${error.message}
                        </div>
                    </div>
                `;
                showMessage('加载知识库列表失败: ' + error.message, 'error');
            }
        }

        // 渲染知识库列表
        function renderDatasetsList(datasets) {
            const container = document.getElementById('datasetsList');
            if (!container) {
                console.error('找不到datasetsList容器');
                return;
            }

            console.log('渲染知识库列表:', datasets);

            if (datasets.length === 0) {
                container.innerHTML = `
                    <div class="datasets-empty">
                        <div>暂无知识库</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #80868b;">
                            请先创建知识库或检查API配置
                        </div>
                    </div>
                `;
                return;
            }

            const html = datasets.map(dataset => {
                const isSelected = dataset.id === selectedDatasetId;
                const statusClass = (dataset.status || 'active') === 'active' ? 'active' : 'inactive';
                const documentCount = dataset.document_count || dataset.count || 1;
                
                console.log('渲染知识库:', dataset.name, '选中状态:', isSelected);
                
                return `
                    <div class="dataset-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectDataset('${dataset.id}', '${dataset.name}')"
                         onmouseover="this.style.transform='translateX(4px)'; this.style.background='#f8f9fa';"
                         onmouseout="this.style.transform='translateX(0)'; this.style.background='${isSelected ? 'linear-gradient(135deg, #e8f0fe 0%, #f0f7ff 100%)' : 'white'}';"
                         style="border: 1px solid #e8eaed; margin-bottom: 8px; border-radius: 8px; padding: 16px; background: ${isSelected ? 'linear-gradient(135deg, #e8f0fe 0%, #f0f7ff 100%)' : 'white'}; transition: all 0.2s ease; cursor: pointer; ${isSelected ? 'border-left: 4px solid #1a73e8; box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);' : ''}">
                        <div class="dataset-info">
                            <div class="dataset-name" style="font-weight: 600; color: #202124; margin-bottom: 6px; font-size: 15px;">
                                📚 ${dataset.name}
                            </div>
                            <div class="dataset-desc" style="font-size: 13px; color: #5f6368; line-height: 1.4; margin-bottom: 8px;">
                                ${dataset.description || '暂无描述'}
                            </div>
                            <div class="dataset-meta" style="display: flex; align-items: center; gap: 12px; font-size: 12px; color: #80868b;">
                                <span class="dataset-count" style="background: #e8f0fe; color: #1a73e8; padding: 2px 8px; border-radius: 12px; font-weight: 500;">
                                    ${documentCount} 个文档
                                </span>
                                <span class="dataset-status ${statusClass}" style="font-size: 12px; padding: 4px 10px; border-radius: 12px; background: ${statusClass === 'active' ? '#d4edda' : '#f8d7da'}; color: ${statusClass === 'active' ? '#155724' : '#721c24'}; font-weight: 500;">
                                    ${dataset.status || 'active'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            console.log('知识库列表渲染完成');
        }

        // 选择知识库
        function selectDataset(datasetId, datasetName) {
            selectedDatasetId = datasetId;
            
            // 更新选中状态显示
            document.getElementById('selectedDataset').textContent = datasetName;
            
            // 更新所有知识库项的选中状态
            document.querySelectorAll('.dataset-item').forEach(item => {
                item.classList.remove('selected');
                // 移除选中样式
                item.style.background = 'white';
                item.style.borderLeft = '1px solid #e8eaed';
                item.style.boxShadow = 'none';
            });
            
            // 为当前点击的项添加选中状态
            const selectedItem = event.target.closest('.dataset-item');
            if (selectedItem) {
                selectedItem.classList.add('selected');
                // 添加选中样式
                selectedItem.style.background = 'linear-gradient(135deg, #e8f0fe 0%, #f0f7ff 100%)';
                selectedItem.style.borderLeft = '4px solid #1a73e8';
                selectedItem.style.boxShadow = '0 2px 8px rgba(26, 115, 232, 0.15)';
            }
            
            // 保存配置
            saveRagConfig();
            
            // 显示选择成功提示
            showMessage(`已选择知识库: ${datasetName}`, 'success');
        }

        // 更新选中知识库显示
        function updateSelectedDatasetDisplay() {
            const display = document.getElementById('selectedDataset');
            if (selectedDatasetId) {
                // 这里可以根据需要显示知识库名称
                display.textContent = `已选择 (ID: ${selectedDatasetId})`;
            } else {
                display.textContent = '未选择';
            }
        }

        // 同步文件到RAG
        async function syncFileToRag(fileId, filename) {
            try {
                if (!selectedDatasetId) {
                    showMessage('请先选择目标知识库', 'error');
                    return;
                }

                const apiUrl = document.getElementById('ragApiUrl').value.trim();
                const apiKey = document.getElementById('ragApiKey').value.trim();
                const syncMethod = document.getElementById('syncMethod').value;
                
                if (!apiUrl || !apiKey) {
                    showMessage('请先配置RAG API', 'error');
                    return;
                }

                // 更新文件同步状态为处理中
                await updateFileSyncStatus(fileId, 'processing');

                // 获取文件详细信息，确保使用正确的原始文件名
                const fileInfoResponse = await fetch(`${API_BASE_URL}/files/${fileId}/info`);
                if (fileInfoResponse.ok) {
                    const fileInfo = await fileInfoResponse.json();
                    const originalFilename = fileInfo.original_filename || filename;
                    console.log('文件信息:', fileInfo);
                    console.log('使用原始文件名:', originalFilename);
                    
                    // 根据选择的同步方式执行
                    switch (syncMethod) {
                        case 'server':
                            await syncFileToRagFromServer(fileId, originalFilename, apiUrl, apiKey);
                            break;
                        case 'url':
                            await syncFileToRagByUrl(fileId, originalFilename, apiUrl, apiKey);
                            break;
                        case 'download':
                            await syncFileToRagByDownload(fileId, originalFilename, apiUrl, apiKey);
                            break;
                        case 'smart':
                            await syncFileToRagWithParse(fileId, originalFilename, apiUrl, apiKey);
                            break;
                        case 'auto':
                        default:
                            await syncFileToRagAuto(fileId, originalFilename, apiUrl, apiKey);
                            break;
                    }
                } else {
                    console.warn('获取文件信息失败，使用默认文件名:', filename);
                    // 如果获取文件信息失败，使用默认文件名继续同步
                    switch (syncMethod) {
                        case 'url':
                            await syncFileToRagByUrl(fileId, filename, apiUrl, apiKey);
                            break;
                        case 'download':
                            await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                            break;
                        case 'smart':
                            await syncFileToRagWithParse(fileId, filename, apiUrl, apiKey);
                            break;
                        case 'auto':
                        default:
                            await syncFileToRagAuto(fileId, filename, apiUrl, apiKey);
                            break;
                    }
                }
            } catch (error) {
                await updateFileSyncStatus(fileId, 'failed');
                showMessage(`同步失败: ${error.message}`, 'error');
            }
        }

        // 使用文件URL方式同步
        async function syncFileToRagByUrl(fileId, filename, apiUrl, apiKey) {
            try {
                const fileUrl = `${API_BASE_URL}/files/${fileId}/download`;
                console.log('=== URL方式同步调试信息 ===');
                console.log('文件ID:', fileId);
                console.log('文件名:', filename);
                console.log('文件URL:', fileUrl);
                console.log('RAG API地址:', apiUrl);
                console.log('目标知识库ID:', selectedDatasetId);
                
                const requestBody = {
                    file_url: fileUrl,
                    filename: filename,  // 使用原始文件名
                    dataset_id: selectedDatasetId
                };
                console.log('请求体:', requestBody);
                
                const syncResponse = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('RAG API响应状态:', syncResponse.status);
                console.log('RAG API响应头:', Object.fromEntries(syncResponse.headers.entries()));

                if (syncResponse.ok) {
                    const responseData = await syncResponse.json();
                    console.log('RAG API成功响应:', responseData);
                    await updateFileSyncStatus(fileId, 'completed');
                    showMessage(`文件同步成功: ${filename}`, 'success');
                } else {
                    const errorData = await syncResponse.json();
                    console.error('RAG API错误响应:', errorData);
                    
                    // 检查是否是"No file part!"错误，如果是则回退到下载方式
                    if (errorData.code === 101 && errorData.message === 'No file part!') {
                        console.log('RAG API不支持URL方式，回退到下载方式...');
                        await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                    } else {
                        await updateFileSyncStatus(fileId, 'failed');
                        showMessage(`文件同步失败: ${filename} - ${errorData.error || errorData.message || '未知错误'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('URL同步异常:', error);
                // 如果URL方式出错，回退到下载方式
                console.log('URL方式出错，回退到下载方式...');
                await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
            }
        }

        // 自动选择同步方式
        async function syncFileToRagAuto(fileId, filename, apiUrl, apiKey) {
            try {
                console.log('=== 自动选择同步方式 ===');
                console.log('文件ID:', fileId);
                console.log('文件名:', filename);
                
                // 先尝试URL方式
                const fileUrl = `${API_BASE_URL}/files/${fileId}/download`;
                
                const syncResponse = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_url: fileUrl,
                        filename: filename,  // 使用原始文件名
                        dataset_id: selectedDatasetId
                    })
                });

                console.log('URL方式响应状态:', syncResponse.status);

                if (syncResponse.ok) {
                    const responseData = await syncResponse.json();
                    console.log('URL方式成功响应:', responseData);
                    await updateFileSyncStatus(fileId, 'completed');
                    showMessage(`文件同步成功: ${filename}`, 'success');
                } else {
                    const errorData = await syncResponse.json();
                    console.log('URL方式失败响应:', errorData);
                    
                    // 检查是否是"No file part!"错误，如果是则回退到下载方式
                    if (errorData.code === 101 && errorData.message === 'No file part!') {
                        console.log('RAG API不支持URL方式，回退到下载方式...');
                        await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                    } else {
                        // 其他错误也回退到下载方式
                        console.log('URL方式失败，尝试下载方式...');
                        await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                    }
                }
            } catch (error) {
                // 如果URL方式出错，回退到下载方式
                console.log('URL方式出错，尝试下载方式...');
                await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
            }
        }

        // 原来的下载方式作为备选方案
        async function syncFileToRagByDownload(fileId, filename, apiUrl, apiKey) {
            try {
                console.log('=== 下载方式同步调试信息 ===');
                console.log('文件ID:', fileId);
                console.log('文件名:', filename);
                
                // 获取文件内容
                const fileResponse = await fetch(`${API_BASE_URL}/files/${fileId}/download`);
                console.log('文件下载响应状态:', fileResponse.status);
                
                if (!fileResponse.ok) {
                    throw new Error('文件下载失败');
                }

                const fileBlob = await fileResponse.blob();
                console.log('文件Blob大小:', fileBlob.size, '字节');
                
                const formData = new FormData();
                formData.append('file', fileBlob, filename);  // 使用原始文件名
                formData.append('dataset_id', selectedDatasetId);
                
                console.log('FormData内容:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}:`, value);
                }

                // 上传到RAG
                const syncResponse = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                console.log('RAG API响应状态:', syncResponse.status);
                console.log('RAG API响应头:', Object.fromEntries(syncResponse.headers.entries()));

                if (syncResponse.ok) {
                    const responseData = await syncResponse.json();
                    console.log('RAG API成功响应:', responseData);
                    await updateFileSyncStatus(fileId, 'completed');
                    showMessage(`文件同步成功: ${filename}`, 'success');
                } else {
                    const errorData = await syncResponse.json();
                    console.error('RAG API错误响应:', errorData);
                    await updateFileSyncStatus(fileId, 'failed');
                    showMessage(`文件同步失败: ${filename} - ${errorData.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('下载方式同步异常:', error);
                await updateFileSyncStatus(fileId, 'failed');
                showMessage(`同步失败: ${error.message}`, 'error');
            }
        }

        // 更新文件同步状态
        async function updateFileSyncStatus(fileId, status) {
            try {
                // 更新前端显示
                const statusElement = document.querySelector(`[data-file-id="${fileId}"] .sync-status`);
                if (statusElement) {
                    statusElement.className = `sync-status ${status}`;
                    statusElement.textContent = {
                        'pending': '待同步',
                        'processing': '同步中...',
                        'completed': '已同步',
                        'failed': '同步失败'
                    }[status];
                }

                // 更新后端数据库
                const response = await fetch(`${API_BASE_URL}/files/${fileId}/sync-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sync_status: status,
                        sync_date: status === 'completed' ? new Date().toISOString() : null
                    })
                });

                if (!response.ok) {
                    console.error('更新同步状态失败:', await response.text());
                }
            } catch (error) {
                console.error('更新同步状态失败:', error);
            }
        }

        // 同步所有文件
        async function syncAllFiles() {
            try {
                if (!selectedDatasetId) {
                    showMessage('请先选择目标知识库', 'error');
                    return;
                }

                const files = await getAllFiles();
                let syncedCount = 0;
                let failedCount = 0;

                for (const file of files) {
                    try {
                        await syncFileToRag(file.file_id, file.original_filename);
                        syncedCount++;
                    } catch (error) {
                        failedCount++;
                    }
                }

                showMessage(`同步完成: 成功 ${syncedCount} 个，失败 ${failedCount} 个`, 'success');
                updateSyncStats();
            } catch (error) {
                showMessage('批量同步失败: ' + error.message, 'error');
            }
        }

        // 获取所有文件
        async function getAllFiles() {
            const files = [];
            
            // 获取项目文件
            const projects = await fetch(`${API_BASE_URL}/projects`).then(r => r.json());
            for (const project of projects) {
                const projectFiles = await fetch(`${API_BASE_URL}/projects/${project._id}/files`).then(r => r.json());
                files.push(...projectFiles);
            }

            // 获取分类文件
            const categories = ['resume', 'company', 'job', 'knowledge'];
            for (const category of categories) {
                const categoryFiles = await fetch(`${API_BASE_URL}/files/category/${category}`).then(r => r.json());
                files.push(...categoryFiles);
            }

            return files;
        }

        // 更新同步统计
        async function updateSyncStats() {
            try {
                const files = await getAllFiles();
                const totalFiles = files.length;
                const syncedFiles = files.filter(f => f.sync_status === 'completed').length;
                const failedFiles = files.filter(f => f.sync_status === 'failed').length;
                const pendingFiles = files.filter(f => !f.sync_status || f.sync_status === 'pending').length;

                document.getElementById('totalFiles').textContent = totalFiles;
                document.getElementById('syncedFiles').textContent = syncedFiles;
                document.getElementById('failedFiles').textContent = failedFiles;
                document.getElementById('pendingFiles').textContent = pendingFiles;
            } catch (error) {
                console.error('更新同步统计失败:', error);
            }
        }

        // 清除同步状态
        function clearSyncStatus() {
            // 这里可以清除所有文件的同步状态
            showMessage('同步状态已清除', 'success');
            updateSyncStats();
        }

        // 页面加载时初始化RAG配置
        if (document.getElementById('rag-config')) {
            loadRagConfig();
            updateSyncStats();
        }

        async function fetchSessions() {
            const res = await fetch(`${CHAT_API_BASE}/chats/${CHAT_ID}/sessions`, {
                headers: { 'Authorization': `Bearer ${CHAT_API_KEY}` }
            });
            const result = await res.json();
            chatSessions = result.data || [];
            renderChatSessionList();
            // 自动选中第一个会话（仅首次或无选中时）
            if (chatSessions.length > 0 && !currentSessionId) {
                selectChatSession(chatSessions[0].session_id);
            }
        }

        async function createSession(name) {
            const res = await fetch(`${CHAT_API_BASE}/chats/${CHAT_ID}/sessions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CHAT_API_KEY}`
                },
                body: JSON.stringify({ name })
            });
            const result = await res.json();
            await fetchSessions();
            // 自动选中新建的会话
            if (result.data && result.data.session_id) {
                selectChatSession(result.data.session_id);
            } else if (chatSessions.length > 0) {
                selectChatSession(chatSessions[0].session_id);
            }
        }

        function showNewSessionInput() {
            document.getElementById('newSessionInput').style.display = 'block';
            document.getElementById('newSessionNameInput').focus();
        }
        function handleNewSessionInput(event) {
            if (event.key === 'Enter') {
                const name = event.target.value.trim();
                if (name) {
                    createSession(name);
                    event.target.value = '';
                    document.getElementById('newSessionInput').style.display = 'none';
                }
            } else if (event.key === 'Escape') {
                event.target.value = '';
                document.getElementById('newSessionInput').style.display = 'none';
            }
        }
        function renderChatSessionList() {
            const list = document.getElementById('chatSessionList');
            if (!list) return;
            if (chatSessions.length === 0) {
                list.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">暂无会话</div>';
                return;
            }
            list.innerHTML = chatSessions.map(s => `
                <div class="chat-session-item${s.session_id === currentSessionId ? ' active' : ''}" style="padding:8px 16px;cursor:pointer;" onclick="selectChatSession('${s.session_id}')">
                    ${s.name || 'New sessions'}
                </div>
            `).join('');
        }
        async function selectChatSession(sessionId) {
            currentSessionId = sessionId;
            renderChatSessionList();
            await fetchMessages(sessionId);
        }
        async function fetchMessages(sessionId) {
            const res = await fetch(`${CHAT_API_BASE}/chats/${CHAT_ID}/sessions/${sessionId}/messages`, {
                headers: { 'Authorization': `Bearer ${CHAT_API_KEY}` }
            });
            const result = await res.json();
            currentSessionMessages = result.data || [];
            renderMessages();
        }
        function renderMessages() {
            const list = document.getElementById('chatMessageList');
            if (!list) return;
            if (!currentSessionMessages.length) {
                list.innerHTML = '<div style="color:#888;text-align:center;padding:40px;">暂无消息</div>';
                return;
            }
            list.innerHTML = currentSessionMessages.map(msg => `
                <div style="margin-bottom: 18px; display: flex; ${msg.role === 'user' ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}">
                    <div style="max-width: 70%; background: ${msg.role === 'user' ? '#e8f0fe' : '#f1f3f4'}; color: #222; padding: 10px 16px; border-radius: 12px; font-size: 15px;">
                        ${msg.content}
                    </div>
                </div>
            `).join('');
            setTimeout(() => { list.scrollTop = list.scrollHeight; }, 100);
        }
        document.getElementById('chatInputForm').onsubmit = async function(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !currentSessionId) return;
            input.value = '';
            await sendMessage(content);
        };
        async function sendMessage(content) {
            // 先把用户消息加到本地流
            currentSessionMessages.push({ role: 'user', content });
            renderMessages();
            // 调用API获取assistant回复
            const res = await fetch(`${CHAT_API_BASE}/chats_openai/${CHAT_ID}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CHAT_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'model',
                    messages: currentSessionMessages,
                    stream: false
                })
            });
            const result = await res.json();
            if (result.choices && result.choices[0] && result.choices[0].message) {
                currentSessionMessages.push({ role: 'assistant', content: result.choices[0].message.content });
                renderMessages();
            } else {
                showMessage(result.error || 'AI回复失败', 'error');
            }
        }
        // 页面初始化时拉取会话列表
        if (document.getElementById('ai-chat')) {
            fetchSessions();
        }

        // 快速配置
        function quickConfig(type) {
            const configs = {
                local: {
                    apiUrl: 'http://localhost/api/v1',
                    apiKey: 'ragflow-JkN2JmM2M4NjUyYjExZjA5Yjc2MDI0Mm'
                },
                test: {
                    apiUrl: 'http://test-server/api/v1',
                    apiKey: 'test-api-key'
                },
                prod: {
                    apiUrl: 'https://ragflow.production.com/api/v1',
                    apiKey: 'prod-api-key'
                }
            };

            const config = configs[type];
            if (config) {
                document.getElementById('ragApiUrl').value = config.apiUrl;
                document.getElementById('ragApiKey').value = config.apiKey;
                showMessage(`已应用${type === 'local' ? '本地' : type === 'test' ? '测试' : '生产'}环境配置`, 'success');
            }
        }

        // 测试渲染效果
        function testRender() {
            const testData = [
                {
                    id: 'test-1',
                    name: '测试知识库1',
                    description: '这是一个测试知识库，用于验证渲染效果',
                    status: 'active',
                    document_count: 5
                },
                {
                    id: 'test-2',
                    name: '测试知识库2',
                    description: '另一个测试知识库，包含更多文档',
                    status: 'active',
                    document_count: 12
                }
            ];
            
            console.log('测试渲染数据:', testData);
            renderDatasetsList(testData);
            showMessage('测试渲染完成', 'success');
        }

        // 页面加载时初始化RAG配置
        if (document.getElementById('rag-config')) {
            loadRagConfig();
            updateSyncStats();
        }

        // 智能同步方式 - 包含解析触发
        async function syncFileToRagWithParse(fileId, filename, apiUrl, apiKey) {
            try {
                console.log('=== 智能同步方式（包含解析触发） ===');
                console.log('文件ID:', fileId);
                console.log('文件名:', filename);
                
                // 先尝试URL方式上传
                const fileUrl = `${API_BASE_URL}/files/${fileId}/download`;
                
                const syncResponse = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_url: fileUrl,
                        filename: filename,  // 使用原始文件名
                        dataset_id: selectedDatasetId,
                        auto_parse: true  // 尝试自动解析
                    })
                });

                console.log('智能同步响应状态:', syncResponse.status);

                if (syncResponse.ok) {
                    const responseData = await syncResponse.json();
                    console.log('智能同步成功响应:', responseData);
                    
                    // 如果上传成功，尝试触发解析
                    await triggerFileParse(fileId, filename, apiUrl, apiKey);
                    
                    await updateFileSyncStatus(fileId, 'completed');
                    showMessage(`文件同步成功: ${filename}`, 'success');
                } else {
                    const errorData = await syncResponse.json();
                    console.log('智能同步失败响应:', errorData);
                    
                    // 检查是否是"No file part!"错误，如果是则回退到下载方式
                    if (errorData.code === 101 && errorData.message === 'No file part!') {
                        console.log('RAG API不支持URL方式，回退到下载方式...');
                        await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                    } else {
                        // 其他错误也回退到下载方式
                        console.log('智能同步失败，尝试下载方式...');
                        await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                    }
                }
            } catch (error) {
                console.error('智能同步异常:', error);
                // 如果智能方式出错，回退到下载方式
                console.log('智能同步出错，回退到下载方式...');
                await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
            }
        }

        // 触发文件解析
        async function triggerFileParse(fileId, filename, apiUrl, apiKey) {
            try {
                console.log('=== 触发文件解析 ===');
                
                // 尝试调用解析API（如果RAG API支持）
                const parseResponse = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents/${fileId}/parse`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (parseResponse.ok) {
                    const parseData = await parseResponse.json();
                    console.log('解析触发成功:', parseData);
                } else {
                    console.log('解析API不可用，需要在RAG界面手动触发解析');
                }
            } catch (error) {
                console.log('解析触发失败，需要在RAG界面手动触发解析:', error);
            }
        }

        // 直接从服务器加载文件同步
        async function syncFileToRagFromServer(fileId, filename, apiUrl, apiKey) {
            try {
                console.log('=== 直接从服务器加载文件同步 ===');
                console.log('文件ID:', fileId);
                console.log('文件名:', filename);
                
                // 获取文件在服务器上的路径信息
                const pathResponse = await fetch(`${API_BASE_URL}/files/${fileId}/server-path`);
                if (!pathResponse.ok) {
                    throw new Error('获取文件路径信息失败');
                }
                
                const pathInfo = await pathResponse.json();
                console.log('文件路径信息:', pathInfo);
                
                if (!pathInfo.exists) {
                    throw new Error('文件在服务器上不存在');
                }
                
                // 直接使用服务器文件路径上传到RAG
                const syncResponse = await fetch(`${apiUrl}/datasets/${selectedDatasetId}/documents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_path: pathInfo.server_path,  // 直接使用服务器文件路径
                        filename: filename,
                        dataset_id: selectedDatasetId,
                        auto_parse: true
                    })
                });

                console.log('服务器加载同步响应状态:', syncResponse.status);

                if (syncResponse.ok) {
                    const responseData = await syncResponse.json();
                    console.log('服务器加载同步成功响应:', responseData);
                    
                    // 检查RAG API是否返回错误
                    if (responseData.code === 101 && responseData.message === 'No file part!') {
                        console.log('RAG API不支持服务器路径方式，回退到下载方式...');
                        await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                        return;
                    }
                    
                    await updateFileSyncStatus(fileId, 'completed');
                    showMessage(`文件同步成功: ${filename}`, 'success');
                } else {
                    const errorData = await syncResponse.json();
                    console.log('服务器加载同步失败响应:', errorData);
                    
                    // 如果服务器路径方式失败，回退到下载方式
                    console.log('服务器路径方式失败，回退到下载方式...');
                    await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
                }
            } catch (error) {
                console.error('服务器加载同步异常:', error);
                // 如果服务器路径方式出错，回退到下载方式
                console.log('服务器路径方式出错，回退到下载方式...');
                await syncFileToRagByDownload(fileId, filename, apiUrl, apiKey);
            }
        }

        // 使用文件URL方式同步
        async function syncFileToRagBackend(fileId) {
            try {
                // 获取RAG配置参数
                const ragApiUrl = document.getElementById('ragApiUrl').value.trim();
                const ragApiKey = document.getElementById('ragApiKey').value.trim();
                const datasetId = selectedDatasetId;
                if (!ragApiUrl || !ragApiKey || !datasetId) {
                    showMessage('请先配置RAG API和选择知识库', 'error');
                    return;
                }
                // 显示处理中
                await updateFileSyncStatus(fileId, 'processing');
                // 调用后端直传接口
                const response = await fetch(`${API_BASE_URL}/files/${fileId}/sync-to-rag`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rag_api_url: ragApiUrl,
                        rag_api_key: ragApiKey,
                        dataset_id: datasetId
                    })
                });
                const result = await response.json();
                if (response.ok && result.code === 0) {
                    await updateFileSyncStatus(fileId, 'completed');
                    showMessage('后端直传RAG成功', 'success');
                } else {
                    await updateFileSyncStatus(fileId, 'failed');
                    showMessage(`后端直传RAG失败: ${result.message || result.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                await updateFileSyncStatus(fileId, 'failed');
                showMessage('后端直传RAG异常: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>